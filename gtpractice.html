<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRACTICE NOW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fret-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }
        .fret-marker.double {
            width: 6px;
            height: 6px;
        }
        .scale-note {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .scale-note:hover {
            transform: scale(1.1);
        }
        .beat-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }
        .beat-indicator.active {
            background: #3b82f6;
            border-color: #1d4ed8;
        }
        .beat-indicator.disabled {
            background: #ef4444;
            border-color: #dc2626;
        }
        .string {
            height: 2px;
            background: #8b5cf6;
            position: relative;
        }
        .violin-string {
            height: 3px;
            background: linear-gradient(to right, #8b5cf6, #a855f7);
            position: relative;
            border-radius: 1px;
        }
        .fret {
            border-right: 2px solid #666;
            height: 100%;
        }
        .position-marker {
            position: absolute;
            width: 1px;
            height: 100%;
            background: #999;
            opacity: 0.3;
        }
        
        /* ë“œëŸ¼ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .drum-row {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-bottom: 4px;
        }
        .drum-label {
            width: 60px;
            font-size: 11px;
            font-weight: bold;
            text-align: right;
            padding-right: 8px;
        }
        .drum-step {
            width: 24px;
            height: 24px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .drum-step:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .drum-step.active {
            background: #3b82f6;
            border-color: #1d4ed8;
            color: white;
        }
        .drum-step.beat {
            border-width: 2px;
            border-color: #ef4444;
        }
        .drum-step.current {
            box-shadow: 0 0 8px #10b981;
            border-color: #10b981;
        }
        .dark-theme .drum-step {
            border-color: #6b7280;
            background: #374151;
        }
        .dark-theme .drum-step:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }
        .dark-theme .drum-step.beat {
            border-color: #ef4444;
        }
        
        /* í…Œë§ˆ ê´€ë ¨ CSS */
        .light-theme {
            background: white;
            color: black;
        }
        .dark-theme {
            background: #1a1a1a;
            color: white;
        }
        .light-theme .panel-bg {
            background: #f8f9fa;
            border-color: #e9ecef;
        }
        .dark-theme .panel-bg {
            background: #2d3748;
            border-color: #4a5568;
        }
        .light-theme .input-bg {
            background: white;
            color: black;
            border-color: #d1d5db;
        }
        .dark-theme .input-bg {
            background: #374151;
            color: white;
            border-color: #6b7280;
        }
        .light-theme .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .light-theme .btn-primary:hover {
            background: #2563eb;
        }
        .dark-theme .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .dark-theme .btn-primary:hover {
            background: #2563eb;
        }
        .light-theme .btn-secondary {
            background: #ef4444;
            color: white;
        }
        .light-theme .btn-secondary:hover {
            background: #dc2626;
        }
        .dark-theme .btn-secondary {
            background: #ef4444;
            color: white;
        }
        .dark-theme .btn-secondary:hover {
            background: #dc2626;
        }
        
        /* ì¬ìƒ ì˜µì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .subdivision-btn {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .subdivision-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .subdivision-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        .dark-theme .subdivision-btn {
            border-color: #6b7280;
        }
        .dark-theme .subdivision-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }
        
        /* ìŒí‘œ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .note-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        /* ì½”ë“œ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .chord-item {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            min-width: 120px;
            flex-shrink: 0;
        }
        .dark-theme .chord-item {
            border-color: #6b7280;
            background: rgba(55, 65, 81, 0.8);
        }
        .chord-item:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .chord-item.playing {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            animation: pulse-glow 2s infinite;
        }
        .dark-theme .chord-item.playing {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.15));
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 8px 35px rgba(16, 185, 129, 0.5); }
        }
        .chord-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            display: none;
            gap: 4px;
        }
        .chord-item:hover .chord-controls {
            display: flex;
        }
        .chord-duration-controls {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 4px;
        }
        .chord-item:hover .chord-duration-controls {
            display: flex;
        }
        .control-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .control-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: scale(1.1);
        }
        .control-btn.delete {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        .control-btn.delete:hover {
            background: #dc2626;
        }
        .chord-duration-display {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
            margin-top: 6px;
            font-weight: 500;
        }
        .chord-name-display {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 4px;
            color: #1f2937;
        }
        .dark-theme .chord-name-display {
            color: #f9fafb;
        }
        .chord-item.playing .chord-name-display {
            color: #10b981;
        }
    </style>
</head>
<body class="light-theme min-h-screen p-4 transition-colors duration-300" id="body">
    <div class="max-w-7xl mx-auto">
        <!-- í—¤ë” -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
            <h1 class="text-3xl font-bold" id="mainTitle">ğŸµ ScaleFlow</h1>
            <div class="flex flex-wrap items-center gap-2 sm:gap-4">
                <!-- ì•…ê¸° ì„ íƒ -->
                <select id="instrumentSelect" class="input-bg rounded px-2 py-1 border">
                    <option value="guitar">ğŸ¸ ê¸°íƒ€</option>
                    <option value="bass4">ğŸ¸ 4í˜„ ë² ì´ìŠ¤</option>
                    <option value="bass5">ğŸ¸ 5í˜„ ë² ì´ìŠ¤</option>
                    <option value="violin">ğŸ» ë°”ì´ì˜¬ë¦°</option>
                </select>
                
                <!-- ì§€íŒ ëª¨ë“œ í† ê¸€ (ê¸°íƒ€ì¼ ë•Œë§Œ) -->
                <div class="flex items-center gap-1 sm:gap-2" id="fretboardModeDiv">
                    <label class="relative inline-flex items-center cursor-pointer" title="ìƒí•˜ë°˜ì „">
                        <input type="checkbox" id="fretboardMode" class="sr-only peer">
                        <div class="w-9 h-5 sm:w-11 sm:h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 sm:after:h-5 sm:after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="text-sm">â‡…</span>
                </div>
                
                <!-- ë°”ì´ì˜¬ë¦° ëª¨ë“œ í† ê¸€ (ë°”ì´ì˜¬ë¦°ì¼ ë•Œë§Œ) -->
                <div class="flex items-center gap-1 sm:gap-2" id="violinModeDiv" style="display: none;">
                    <label class="relative inline-flex items-center cursor-pointer" title="ìƒí•˜ë°˜ì „">
                        <input type="checkbox" id="violinMode" class="sr-only peer" checked>
                        <div class="w-9 h-5 sm:w-11 sm:h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 sm:after:h-5 sm:after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="text-sm">â‡…</span>
                </div>
                
                <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
                <div class="flex items-center gap-1 sm:gap-2">
                    <span class="text-sm">ğŸŒ</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="darkMode" class="sr-only peer">
                        <div class="w-9 h-5 sm:w-11 sm:h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 sm:after:h-5 sm:after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="text-sm">ğŸŒ™</span>
                </div>
            </div>
        </div>
        
        <!-- ë©”íŠ¸ë¡œë†ˆ & ë°•ì í‘œì‹œê¸° -->
        <div class="panel-bg rounded-lg p-4 mb-4 border">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ğŸ¥ ë©”íŠ¸ë¡œë†ˆ</h3>
                <div class="flex items-center gap-4">
                    <!-- ì½”ë“œì§„í–‰ ëª¨ë“œ í† ê¸€ -->
                    <div class="flex items-center gap-2">
                        <span>ë©”íŠ¸ë¡œë†ˆ</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="chordMode" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                        <span>ì½”ë“œì§„í–‰</span>
                    </div>
                    <!-- ë¦¬ë“¬ ì„¤ì • ë²„íŠ¼ -->
                    <div class="relative">
                        <button id="rhythmToggle" class="btn-primary rounded px-3 py-2">ğŸ¥</button>
                        <div id="rhythmPanel" class="absolute top-full right-0 mt-2 panel-bg rounded-lg p-4 border shadow-lg z-50 min-w-[600px]" style="display: none;">
                            <h3 class="text-lg font-semibold mb-3">ğŸ¥ ë¦¬ë“¬ íŒ¨í„´ ì„¤ì •</h3>
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span>í”„ë¦¬ì…‹:</span>
                                    <div class="flex gap-2">
                                        <button onclick="loadDrumPreset('rock')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Rock</button>
                                        <button onclick="loadDrumPreset('pop')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Pop</button>
                                        <button onclick="loadDrumPreset('funk')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Funk</button>
                                        <button onclick="clearDrumPattern()" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">Clear</button>
                                    </div>
                                </div>
                            </div>
                            <div id="drumGrid" class="space-y-2 overflow-x-auto">
                                <!-- ë“œëŸ¼ ê·¸ë¦¬ë“œê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                            </div>
                            <div class="mt-4 grid grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">í‚¥ë“œëŸ¼</label>
                                    <input type="range" id="kickVolume" min="0" max="100" value="80" class="w-full">
                                    <div class="text-center text-sm"><span id="kickVolumeDisplay">80</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ìŠ¤ë„¤ì–´</label>
                                    <input type="range" id="snareVolume" min="0" max="100" value="70" class="w-full">
                                    <div class="text-center text-sm"><span id="snareVolumeDisplay">70</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">í•˜ì´í–‡</label>
                                    <input type="range" id="hihatVolume" min="0" max="100" value="50" class="w-full">
                                    <div class="text-center text-sm"><span id="hihatVolumeDisplay">50</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">í¬ë˜ì‹œ</label>
                                    <input type="range" id="crashVolume" min="0" max="100" value="60" class="w-full">
                                    <div class="text-center text-sm"><span id="crashVolumeDisplay">60</span>%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ìŒëŸ‰ ì¡°ì ˆ ë²„íŠ¼ -->
                    <div class="relative">
                        <button id="volumeToggle" class="btn-primary rounded px-3 py-2">ğŸ”Š</button>
                        <div id="volumePanel" class="absolute top-full right-0 mt-2 panel-bg rounded-lg p-4 border shadow-lg z-50 min-w-[300px]" style="display: none;">
                            <h3 class="text-lg font-semibold mb-3">ğŸ”Š ìŒëŸ‰ ì¡°ì ˆ</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">ë©”íŠ¸ë¡œë†ˆ</label>
                                    <input type="range" id="metronomeVolume" min="0" max="100" value="50" class="w-full">
                                    <div class="text-center text-sm"><span id="metronomeVolumeDisplay">50</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ë² ì´ìŠ¤</label>
                                    <input type="range" id="bassVolume" min="0" max="100" value="50" class="w-full">
                                    <div class="text-center text-sm"><span id="bassVolumeDisplay">50</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">í”¼ì•„ë…¸</label>
                                    <input type="range" id="pianoVolume" min="0" max="100" value="50" class="w-full">
                                    <div class="text-center text-sm"><span id="pianoVolumeDisplay">50</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ë“œëŸ¼ ì „ì²´</label>
                                    <input type="range" id="drumMasterVolume" min="0" max="100" value="70" class="w-full">
                                    <div class="text-center text-sm"><span id="drumMasterVolumeDisplay">70</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">ì•…ê¸°ìŒ</label>
                                    <input type="range" id="instrumentVolume" min="0" max="100" value="70" class="w-full">
                                    <div class="text-center text-sm"><span id="instrumentVolumeDisplay">70</span>%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-12 gap-4 items-center">
                <!-- ë©”íŠ¸ë¡œë†ˆ ì„¤ì • -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium mb-1">BPM</label>
                    <input type="number" id="bpm" value="120" min="60" max="200" class="w-full input-bg rounded px-3 py-2 border">
                </div>
                <div class="col-span-1">
                    <label class="block text-sm font-medium mb-1">ë°•ìí‘œ</label>
                    <select id="timeSignature" class="w-full input-bg rounded px-3 py-2 border">
                        <option value="2/2">2/2</option>
                        <option value="3/4">3/4</option>
                        <option value="4/4" selected>4/4</option>
                        <option value="6/8">6/8</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium mb-1">ì‚¬ìš´ë“œ</label>
                    <select id="metronomeSound" class="w-full input-bg rounded px-3 py-2 border">
                        <option value="beep">ë¹„í”„</option>
                        <option value="drum">ë“œëŸ¼</option>
                        <option value="pattern">íŒ¨í„´</option>
                    </select>
                </div>
                
                <!-- ì¬ìƒ ì˜µì…˜ -->
                <div class="col-span-3">
                    <label class="block text-sm font-medium mb-1">ì¬ìƒ ì˜µì…˜</label>
                    <div class="grid grid-cols-6 gap-1">
                        <button class="subdivision-btn active" data-value="quarter" title="4ë¶„ìŒí‘œ">â™©</button>
                        <button class="subdivision-btn" data-value="eighth" title="8ë¶„ìŒí‘œ">â™«</button>
                        <button class="subdivision-btn" data-value="triplet" title="ì…‹ì‡ë‹¨ìŒí‘œ">â™ªâ™ªâ™ª</button>
                        <button class="subdivision-btn" data-value="tripletGhost" title="ì…‹ì‡ë‹¨ìŒí‘œ(ê°€ìš´ë°ë¹ˆ)">â™ª_â™ª</button>
                        <button class="subdivision-btn" data-value="sixteenth" title="16ë¶„ìŒí‘œ">â™¬</button>
                        <button class="subdivision-btn" data-value="sixteenthSparse" title="16ë¶„ìŒí‘œ(1,4ë§Œ)">â™¬_â™¬</button>
                    </div>
                </div>
                
                <!-- ë°•ì í‘œì‹œê¸° -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium mb-1">ë°•ì í‘œì‹œ</label>
                    <div id="beatIndicators" class="flex gap-2"></div>
                </div>
                
                <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
                <div class="col-span-2">
                    <div class="flex gap-2">
                        <button id="metronomePlay" class="btn-primary rounded px-4 py-2 flex-1">ì¬ìƒ</button>
                        <button id="metronomeStop" class="btn-secondary rounded px-4 py-2 flex-1">ì •ì§€</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì½”ë“œ ì§„í–‰ ì„¤ì • ë° í‘œì‹œ (ì½”ë“œ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) -->
        <div id="chordProgressionPanel" class="panel-bg rounded-lg p-4 mb-4 border" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">ğŸ¹ ì½”ë“œì§„í–‰</h3>
                <div class="flex items-center gap-4">
                    <span>í˜„ì¬: <span id="currentChordDisplay">-</span></span>
                    <button id="addChord" class="btn-primary rounded px-3 py-2">+ ì½”ë“œ ì¶”ê°€</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <div id="chordContainer" class="flex gap-3 min-w-max">
                    <!-- ì½”ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>

        <!-- ìŠ¤ì¼€ì¼ & íƒ€ì´ë¨¸ ì„¤ì • -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <!-- ìŠ¤ì¼€ì¼ ì„¤ì • -->
            <div class="panel-bg rounded-lg p-4 border">
                <h3 class="text-lg font-semibold mb-3">ğŸµ ìŠ¤ì¼€ì¼ ì„¤ì •</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">í‚¤</label>
                        <select id="keyCenter" class="w-full input-bg rounded px-3 py-2 border">
                            <option value="C">C</option>
                            <option value="C#">C#</option>
                            <option value="D">D</option>
                            <option value="D#">D#</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">F#</option>
                            <option value="G">G</option>
                            <option value="G#">G#</option>
                            <option value="A">A</option>
                            <option value="A#">A#</option>
                            <option value="B">B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ìŠ¤ì¼€ì¼</label>
                        <select id="scaleType" class="w-full input-bg rounded px-3 py-2 border">
                            <option value="major">ë©”ì´ì €</option>
                            <option value="dorian">ë„ë¦¬ì•ˆ</option>
                            <option value="phrygian">í”„ë¦¬ì§€ì•ˆ</option>
                            <option value="lydian">ë¦¬ë””ì•ˆ</option>
                            <option value="mixolydian">ë¯¹ì†”ë¦¬ë””ì–¸</option>
                            <option value="minor">ë§ˆì´ë„ˆ</option>
                            <option value="locrian">ë¡œí¬ë¦¬ì•ˆ</option>
                            <option value="majorPentatonic">ë©”ì´ì € íœíƒ€</option>
                            <option value="minorPentatonic">ë§ˆì´ë„ˆ íœíƒ€</option>
                            <option value="wholeTone">í™€í†¤</option>
                            <option value="harmonicMinor">í•˜ëª¨ë‹‰ ë§ˆì´ë„ˆ</option>
                            <option value="bebop">ë¹„ë°¥</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- íƒ€ì´ë¨¸ ì„¤ì • -->
            <div class="panel-bg rounded-lg p-4 border">
                <h3 class="text-lg font-semibold mb-3">â±ï¸ ì—°ìŠµ íƒ€ì´ë¨¸</h3>
                <div class="grid grid-cols-4 gap-3 items-end">
                    <div>
                        <label class="block text-sm font-medium mb-1">íƒ€ì…</label>
                        <select id="timerType" class="w-full input-bg rounded px-3 py-2 border">
                            <option value="time">ì‹œê°„</option>
                            <option value="bars">ì†Œì ˆ</option>
                        </select>
                    </div>
                    <div id="timeTimerDiv">
                        <label class="block text-sm font-medium mb-1">ì‹œê°„</label>
                        <select id="timeTimer" class="w-full input-bg rounded px-3 py-2 border">
                            <option value="5">5ë¶„</option>
                            <option value="10">10ë¶„</option>
                            <option value="15">15ë¶„</option>
                            <option value="20">20ë¶„</option>
                        </select>
                    </div>
                    <div id="barsTimerDiv" style="display: none;">
                        <label class="block text-sm font-medium mb-1">ì†Œì ˆ</label>
                        <input type="number" id="barsTimer" value="32" min="1" max="999" class="w-full input-bg rounded px-3 py-2 border">
                    </div>
                    <div class="text-center">
                        <div id="timerDisplay" class="text-lg font-bold mb-2">5:00</div>
                        <button id="timerStart" class="btn-primary rounded px-4 py-2 w-full">ì‹œì‘</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì•…ê¸° ì§€íŒ -->
        <div class="panel-bg rounded-lg p-4 border">
            <h3 class="text-xl font-semibold mb-4 text-center" id="fretboardTitle">ê¸°íƒ€ í”„ë ›ë³´ë“œ</h3>
            <div class="overflow-x-auto px-4">
                <div id="fretboard" class="relative min-w-[1100px] mx-auto"></div>
            </div>
        </div>


    </div>

    <script>
        // ìŒê³„ ì •ì˜
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // ì•…ê¸°ë³„ íŠœë‹ ì •ì˜ (ì˜¥íƒ€ë¸Œ í¬í•¨)
        const guitarTuning = [
            {note: 'E', octave: 2}, // 6í˜„ (ê°€ì¥ ë‚®ì€ í˜„)
            {note: 'A', octave: 2}, // 5í˜„
            {note: 'D', octave: 3}, // 4í˜„
            {note: 'G', octave: 3}, // 3í˜„
            {note: 'B', octave: 3}, // 2í˜„
            {note: 'E', octave: 4}  // 1í˜„ (ê°€ì¥ ë†’ì€ í˜„)
        ];
        
        const bass4Tuning = [
            {note: 'E', octave: 1}, // 4í˜„ (ê°€ì¥ ë‚®ì€ í˜„)
            {note: 'A', octave: 1}, // 3í˜„
            {note: 'D', octave: 2}, // 2í˜„
            {note: 'G', octave: 2}  // 1í˜„ (ê°€ì¥ ë†’ì€ í˜„)
        ];
        
        const bass5Tuning = [
            {note: 'B', octave: 0}, // 5í˜„ (ê°€ì¥ ë‚®ì€ í˜„)
            {note: 'E', octave: 1}, // 4í˜„
            {note: 'A', octave: 1}, // 3í˜„
            {note: 'D', octave: 2}, // 2í˜„
            {note: 'G', octave: 2}  // 1í˜„ (ê°€ì¥ ë†’ì€ í˜„)
        ];
        
        const violinTuning = [
            {note: 'G', octave: 3}, // 4í˜„ (ê°€ì¥ ë‚®ì€ í˜„)
            {note: 'D', octave: 4}, // 3í˜„
            {note: 'A', octave: 4}, // 2í˜„
            {note: 'E', octave: 5}  // 1í˜„ (ê°€ì¥ ë†’ì€ í˜„)
        ];
        
        let currentInstrument = 'guitar'; // 'guitar', 'bass4', 'bass5', ë˜ëŠ” 'violin'
        let stringTuning = guitarTuning;

        // ìŠ¤ì¼€ì¼ íŒ¨í„´ ì •ì˜ (ë°˜ìŒ ê°„ê²©)
        const scalePatterns = {
            major: [0, 2, 4, 5, 7, 9, 11],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            minor: [0, 2, 3, 5, 7, 8, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            majorPentatonic: [0, 2, 4, 7, 9],
            minorPentatonic: [0, 3, 5, 7, 10],
            minorMajorPentatonic: [0, 3, 4, 7, 10],
            wholeTone: [0, 2, 4, 6, 8, 10],
            mixolydianbF9bF13: [0, 1, 4, 5, 7, 8, 10],
            naturalMinor: [0, 2, 3, 5, 7, 8, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            bebop: [0, 2, 4, 5, 7, 9, 10, 11]
        };

        // ìŠ¤ì¼€ì¼ ë„ìˆ˜ í‘œê¸°
        const scaleIntervals = {
            major: ['R', '2', '3', '4', '5', '6', '7'],
            dorian: ['R', '2', 'b3', '4', '5', '6', 'b7'],
            phrygian: ['R', 'b2', 'b3', '4', '5', 'b6', 'b7'],
            lydian: ['R', '2', '3', '#4', '5', '6', '7'],
            mixolydian: ['R', '2', '3', '4', '5', '6', 'b7'],
            minor: ['R', '2', 'b3', '4', '5', 'b6', 'b7'],
            locrian: ['R', 'b2', 'b3', '4', 'b5', 'b6', 'b7'],
            majorPentatonic: ['R', '2', '3', '5', '6'],
            minorPentatonic: ['R', 'b3', '4', '5', 'b7'],
            minorMajorPentatonic: ['R', 'b3', '3', '5', 'b7'],
            wholeTone: ['R', '2', '3', '#4', '#5', '#6'],
            mixolydianbF9bF13: ['R', 'b2', '3', '4', '5', 'b6', 'b7'],
            naturalMinor: ['R', '2', 'b3', '4', '5', 'b6', 'b7'],
            harmonicMinor: ['R', '2', 'b3', '4', '5', 'b6', '7'],
            bebop: ['R', '2', '3', '4', '5', '6', 'b7', '7']
        };

        // ìƒ‰ìƒ ì •ì˜
        const intervalColors = {
            'R': '#ef4444',     // ë¹¨ê°• (ë£¨íŠ¸)
            '2': '#f97316',     // ì£¼í™©
            'b2': '#f59e0b',    // ë…¸ë‘-ì£¼í™©
            '3': '#eab308',     // ë…¸ë‘
            'b3': '#84cc16',    // ì—°ë‘
            '4': '#22c55e',     // ì´ˆë¡
            '#4': '#10b981',    // ì²­ë¡
            '5': '#06b6d4',     // í•˜ëŠ˜
            'b5': '#0ea5e9',    // íŒŒë‘
            '6': '#3b82f6',     // ì§„íŒŒë‘
            'b6': '#6366f1',    // ë‚¨ë³´ë¼
            '7': '#8b5cf6',     // ë³´ë¼
            'b7': '#a855f7',    // ì§„ë³´ë¼
            '#5': '#d946ef',    // ìì£¼
            '#6': '#ec4899'     // ë¶„í™
        };

        let metronomeInterval = null;
        let chordInterval = null;
        let timerInterval = null;
        let currentBeat = 0;
        let beatCount = 4;
        let beatStates = [true, true, true, true];
        let audioContext = null;
        let timerSeconds = 0;
        let timerBars = 0;
        let currentChordBar = 0;
        let currentSubdivision = 'quarter';
        let currentDrumStep = 0;
        
        // ë“œëŸ¼ íŒ¨í„´ ì‹œìŠ¤í…œ
        let drumPattern = {
            kick: new Array(16).fill(false),
            snare: new Array(16).fill(false),
            hihat: new Array(16).fill(false),
            crash: new Array(16).fill(false)
        };
        
        // ì½”ë“œ ì§„í–‰ ì‹œìŠ¤í…œ
        let chordProgression = [
            { root: 'C', quality: 'major', seventh: '', tensions: [], duration: 4 },
            { root: 'A', quality: 'minor', seventh: '', tensions: [], duration: 4 },
            { root: 'F', quality: 'major', seventh: '', tensions: [], duration: 4 },
            { root: 'G', quality: 'major', seventh: '', tensions: [], duration: 4 }
        ];
        let currentChordIndex = 0;
        let currentChordBeat = 0;

        // ìŒí‘œ ì•„ì´ì½˜ ì •ì˜ (í–¥í›„ ë²¡í„° ì´ë¯¸ì§€ë¡œ êµì²´ ê°€ëŠ¥)
        const noteIcons = {
            quarter: 'â™©',
            eighth: 'â™«',
            triplet: 'â™ªâ™ªâ™ª',
            tripletGhost: 'â™ª_â™ª',
            sixteenth: 'â™¬',
            sixteenthSparse: 'â™¬_â™¬'
        };

        // ìŒí‘œ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
        function createNoteIcon(noteType) {
            // í–¥í›„ ë²¡í„° ì´ë¯¸ì§€ ì§€ì›ì„ ìœ„í•œ êµ¬ì¡°
            const iconContainer = document.createElement('div');
            iconContainer.className = 'note-icon-container';
            
            // ì´ë¯¸ì§€ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸ (í–¥í›„ êµ¬í˜„)
            const imagePath = `/images/notes/${noteType}.svg`;
            
            // í˜„ì¬ëŠ” í…ìŠ¤íŠ¸ ì•„ì´ì½˜ ì‚¬ìš©, í–¥í›„ ì´ë¯¸ì§€ë¡œ êµì²´ ê°€ëŠ¥
            iconContainer.innerHTML = noteIcons[noteType] || 'â™©';
            
            // í–¥í›„ ì´ë¯¸ì§€ ì§€ì› ì½”ë“œ (ì£¼ì„ ì²˜ë¦¬)
            /*
            const img = new Image();
            img.onload = () => {
                iconContainer.innerHTML = `<img src="${imagePath}" alt="${noteType}" style="width: 100%; height: 100%;">`;
            };
            img.onerror = () => {
                iconContainer.innerHTML = noteIcons[noteType] || 'â™©';
            };
            img.src = imagePath;
            */
            
            return iconContainer;
        }

        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // ë¹„í”„ ì†Œë¦¬ ìƒì„± (í•©ì„±ìŒë§Œ ì‚¬ìš©)
        async function playBeep(frequency = 800, duration = 100) {
            // í•©ì„±ìŒìœ¼ë¡œ ì¬ìƒ
            playBeepSynthetic(frequency, duration);
        }

        // ë¹„í”„ í•©ì„±ìŒ ì¬ìƒ (ê¸°ì¡´ ë¡œì§)
        function playBeepSynthetic(frequency = 800, duration = 100) {
            if (!audioContext) return;
            
            const metronomeVol = document.getElementById('metronomeVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3 * metronomeVol, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // ê°œì„ ëœ ë“œëŸ¼ ì‚¬ìš´ë“œ ì¬ìƒ (ê²¹ì¹¨ ë°©ì§€ ë° ì¦‰ì‹œ ì •ì§€ ì§€ì›)
        function playDrumSoundImproved(drumType, step = 0, volume = 1) {
            const trackingKey = `${drumType}_${step}`;
            
            // ì´ì „ì— ì¬ìƒ ì¤‘ì¸ ê°™ì€ ë“œëŸ¼ íƒ€ì… ì •ì§€ (ê²¹ì¹¨ ë°©ì§€)
            if (drumPlayingSounds.has(drumType)) {
                const prevAudio = drumPlayingSounds.get(drumType);
                if (prevAudio && !prevAudio.paused) {
                    prevAudio.pause();
                    prevAudio.currentTime = 0;
                }
            }
            
            // ìŒì› íŒŒì¼ ê²½ë¡œ
            const samplePath = `sounds/drums/${drumType}.wav`;
            const sample = audioPool.samples.get(samplePath);
            
            if (sample) {
                // ìŒì› íŒŒì¼ë¡œ ì¬ìƒ
                try {
                    let drumVol;
                    switch (drumType) {
                        case 'kick':
                            drumVol = document.getElementById('kickVolume').value / 100;
                            break;
                        case 'snare':
                            drumVol = document.getElementById('snareVolume').value / 100;
                            break;
                        case 'hihat':
                            drumVol = document.getElementById('hihatVolume').value / 100;
                            break;
                        case 'crash':
                            drumVol = document.getElementById('crashVolume').value / 100;
                            break;
                        default:
                            drumVol = 0.5;
                    }
                    
                    const drumMasterVol = document.getElementById('drumMasterVolume').value / 100;
                    const clonedAudio = sample.cloneNode();
                    clonedAudio.volume = 0.7 * drumVol * drumMasterVol * volume;
                    clonedAudio.currentTime = 0;
                    
                    // ì¬ìƒ ì¶”ì ì— ì¶”ê°€
                    drumPlayingSounds.set(drumType, clonedAudio);
                    
                    // ì¬ìƒ ì™„ë£Œ ì‹œ ì¶”ì ì—ì„œ ì œê±°
                    clonedAudio.addEventListener('ended', () => {
                        if (drumPlayingSounds.get(drumType) === clonedAudio) {
                            drumPlayingSounds.delete(drumType);
                        }
                    });
                    
                    clonedAudio.play();
                } catch (error) {
                    console.log(`Failed to play drum sample: ${samplePath}`);
                    // ì‹¤íŒ¨ ì‹œ í•©ì„±ìŒìœ¼ë¡œ ëŒ€ì²´
                    playDrumSoundSynthetic(drumType, volume);
                }
            } else {
                // ìŒì›ì´ ì—†ìœ¼ë©´ í•©ì„±ìŒìœ¼ë¡œ ì¬ìƒ
                playDrumSoundSynthetic(drumType, volume);
            }
        }
        
        // ë“œëŸ¼ ì‚¬ìš´ë“œ ìƒì„± (ìŒì› ìš°ì„ , ì—†ìœ¼ë©´ í•©ì„±ìŒ) - ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ (í˜¸í™˜ì„±)
        async function playDrumSound(drumType, volume = 1) {
            playDrumSoundImproved(drumType, 0, volume);
        }

        // ë“œëŸ¼ í•©ì„±ìŒ ì¬ìƒ (ê¸°ì¡´ ë¡œì§)
        function playDrumSoundSynthetic(drumType, volume = 1) {
            if (!audioContext) return;
            
            let drumVol;
            switch (drumType) {
                case 'kick':
                    drumVol = document.getElementById('kickVolume').value / 100;
                    break;
                case 'snare':
                    drumVol = document.getElementById('snareVolume').value / 100;
                    break;
                case 'hihat':
                    drumVol = document.getElementById('hihatVolume').value / 100;
                    break;
                case 'crash':
                    drumVol = document.getElementById('crashVolume').value / 100;
                    break;
                default:
                    drumVol = 0.5;
            }
            
            const drumMasterVol = document.getElementById('drumMasterVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filterNode = audioContext.createBiquadFilter();
            
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch (drumType) {
                case 'kick':
                    oscillator.frequency.value = 60;
                    oscillator.type = 'sine';
                    filterNode.type = 'lowpass';
                    filterNode.frequency.value = 100;
                    gainNode.gain.setValueAtTime(0.8 * drumVol * drumMasterVol * volume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    break;
                case 'snare':
                    oscillator.frequency.value = 200;
                    oscillator.type = 'square';
                    filterNode.type = 'highpass';
                    filterNode.frequency.value = 1000;
                    gainNode.gain.setValueAtTime(0.5 * drumVol * drumMasterVol * volume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    break;
                case 'hihat':
                    oscillator.frequency.value = 8000;
                    oscillator.type = 'square';
                    filterNode.type = 'highpass';
                    filterNode.frequency.value = 5000;
                    gainNode.gain.setValueAtTime(0.3 * drumVol * drumMasterVol * volume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    break;
                case 'crash':
                    oscillator.frequency.value = 4000;
                    oscillator.type = 'sawtooth';
                    filterNode.type = 'highpass';
                    filterNode.frequency.value = 2000;
                    gainNode.gain.setValueAtTime(0.4 * drumVol * drumMasterVol * volume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                    break;
            }
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1);
        }

        // ë“œëŸ¼ ì‚¬ìš´ë“œ ìƒì„± (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
        function playDrum(drumType = 'kick', duration = 100) {
            playDrumSound(drumType, 1);
        }

        // ë² ì´ìŠ¤ ì†Œë¦¬ ìƒì„± (ìŒì› ìš°ì„ , ì—†ìœ¼ë©´ í•©ì„±ìŒ)
        async function playBass(frequency = 82, duration = 500, note = null, octave = null) {
            // ì£¼íŒŒìˆ˜ì—ì„œ ìŒí‘œì™€ ì˜¥íƒ€ë¸Œ ì¶”ì¶œ (ì œê³µë˜ì§€ ì•Šì€ ê²½ìš°)
            if (!note || !octave) {
                const noteData = frequencyToNote(frequency);
                note = noteData.note;
                octave = noteData.octave;
            }
            
            // E1-D#2 ë²”ìœ„ ë‚´ë¡œ ì œí•œ (ë² ì´ìŠ¤ ìŒì› ë²”ìœ„)
            if (octave < 1) {
                octave = 1;
                note = 'E'; // ìµœì €ìŒì€ E1
            }
            if (octave > 2) {
                octave = 2;
                note = 'D#'; // ìµœê³ ìŒì€ D#2
            }
            if (octave === 1 && notes.indexOf(note) < notes.indexOf('E')) {
                note = 'E'; // 1ì˜¥íƒ€ë¸Œì—ì„œ Eë³´ë‹¤ ë‚®ìœ¼ë©´ E1ë¡œ
            }
            if (octave === 2 && notes.indexOf(note) > notes.indexOf('D#')) {
                note = 'D#'; // 2ì˜¥íƒ€ë¸Œì—ì„œ D#ë³´ë‹¤ ë†’ìœ¼ë©´ D#2ë¡œ
            }
            
            // ìŒì› íŒŒì¼ ê²½ë¡œ (ì›ë˜ ê²½ë¡œë¡œ ê²€ìƒ‰)
            const samplePath = `sounds/bass4/${note}${octave}.wav`;
            const sample = audioPool.samples.get(samplePath);
            
            if (sample) {
                // ìŒì› íŒŒì¼ë¡œ ì¬ìƒ
                try {
                    const bassVol = document.getElementById('bassVolume').value / 100;
                    const clonedAudio = sample.cloneNode();
                    clonedAudio.volume = 0.7 * bassVol;
                    clonedAudio.currentTime = 0;
                    await clonedAudio.play();
                } catch (error) {
                    console.log(`Failed to play bass sample: ${samplePath}`);
                    // ì‹¤íŒ¨ ì‹œ í•©ì„±ìŒìœ¼ë¡œ ëŒ€ì²´
                    playBassSynthetic(frequency, duration, note, octave);
                }
            } else {
                // ìŒì›ì´ ì—†ìœ¼ë©´ í•©ì„±ìŒìœ¼ë¡œ ì¬ìƒ
                playBassSynthetic(frequency, duration, note, octave);
            }
        }
        
        // ë² ì´ìŠ¤ í•©ì„±ìŒ ì¬ìƒ
        function playBassSynthetic(frequency, duration, note, octave) {
            if (!audioContext) return;
            
            const bassVol = document.getElementById('bassVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.2 * bassVol, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // ì‹¤ì œ ìŒ ì£¼íŒŒìˆ˜ ê³„ì‚° (C4 = 261.63Hz ê¸°ì¤€)
        function getNoteFrequency(note, octave) {
            const noteFrequencies = {
                'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
                'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
            };
            
            const semitoneFromC4 = (octave - 4) * 12 + noteFrequencies[note];
            return 261.63 * Math.pow(2, semitoneFromC4 / 12);
        }

        // ì£¼íŒŒìˆ˜ë¥¼ ìŒí‘œì™€ ì˜¥íƒ€ë¸Œë¡œ ë³€í™˜ (ì—­í•¨ìˆ˜)
        function frequencyToNote(frequency) {
            const semitoneFromC4 = Math.round(12 * Math.log2(frequency / 261.63));
            const octave = Math.floor(semitoneFromC4 / 12) + 4;
            const noteIndex = ((semitoneFromC4 % 12) + 12) % 12; // ìŒìˆ˜ ì²˜ë¦¬
            
            return {
                note: notes[noteIndex],
                octave: octave
            };
        }

        // ì˜¤ë””ì˜¤ í’€ ê´€ë¦¬ ì‹œìŠ¤í…œ (ìŒì› ê²¹ì¹¨ ë°©ì§€)
        const audioPool = {
            samples: new Map(), // ë¡œë“œëœ ìƒ˜í”Œ ìºì‹œ
            playingSounds: new Map(), // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ì‚¬ìš´ë“œ ì¶”ì 
            maxPolyphony: 8 // ìµœëŒ€ ë™ì‹œ ì¬ìƒ ìˆ˜
        };

        // URL ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„± (# -> %23 ì¸ì½”ë”©)
        function createSafeFileName(note, octave) {
            const safeNote = note.replace('#', '%23');
            return `${safeNote}${octave}.wav`;
        }

        // ì˜¤ë””ì˜¤ ìƒ˜í”Œ í”„ë¦¬ë¡œë“œ (ì•…ê¸°ë³„ ìŒì—­ëŒ€ ì œí•œ)
        async function preloadAudioSamples(instrument) {
            const samplePaths = [];
            
            // ê° ì•…ê¸°ë³„ í•„ìš”í•œ ìŒì—­ëŒ€ ìƒ˜í”Œ ê²½ë¡œ ìƒì„±
            if (instrument === 'piano') {
                // í”¼ì•„ë…¸: C3ë¶€í„° B4ê¹Œì§€ë§Œ
                for (let octave = 3; octave <= 4; octave++) {
                    notes.forEach(note => {
                        const fileName = createSafeFileName(note, octave);
                        const originalPath = `sounds/${instrument}/${note}${octave}.wav`;
                        const safePath = `sounds/${instrument}/${fileName}`;
                        samplePaths.push({ originalPath, safePath });
                    });
                }
            } else if (instrument === 'bass4') {
                // ë² ì´ìŠ¤4: E1ë¶€í„° D#2ê¹Œì§€ë§Œ (bass4 í´ë”)
                const bassNotes = ['E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']; // 1ì˜¥íƒ€ë¸Œ
                const bassNotes2 = ['C', 'C#', 'D', 'D#']; // 2ì˜¥íƒ€ë¸Œ
                
                bassNotes.forEach(note => {
                    const fileName = createSafeFileName(note, 1);
                    const originalPath = `sounds/bass4/${note}1.wav`;
                    const safePath = `sounds/bass4/${fileName}`;
                    samplePaths.push({ originalPath, safePath });
                });
                bassNotes2.forEach(note => {
                    const fileName = createSafeFileName(note, 2);
                    const originalPath = `sounds/bass4/${note}2.wav`;
                    const safePath = `sounds/bass4/${fileName}`;
                    samplePaths.push({ originalPath, safePath });
                });
            } else if (instrument === 'bass5') {
                // ë² ì´ìŠ¤5: B0ë¶€í„° G2ê¹Œì§€ (bass5 í´ë”)
                const fileName = createSafeFileName('B', 0);
                const originalPath = `sounds/bass5/B0.wav`;
                const safePath = `sounds/bass5/${fileName}`;
                samplePaths.push({ originalPath, safePath });
                
                for (let octave = 1; octave <= 2; octave++) {
                    notes.forEach(note => {
                        const fileName = createSafeFileName(note, octave);
                        const originalPath = `sounds/bass5/${note}${octave}.wav`;
                        const safePath = `sounds/bass5/${fileName}`;
                        samplePaths.push({ originalPath, safePath });
                    });
                }
            } else {
                // ê¸°íƒ€, ë°”ì´ì˜¬ë¦°: ì „ì²´ ìŒì—­ëŒ€
                for (let octave = 1; octave <= 6; octave++) {
                    notes.forEach(note => {
                        const fileName = createSafeFileName(note, octave);
                        const originalPath = `sounds/${instrument}/${note}${octave}.wav`;
                        const safePath = `sounds/${instrument}/${fileName}`;
                        samplePaths.push({ originalPath, safePath });
                    });
                }
            }
            
            // ë³‘ë ¬ë¡œ ìƒ˜í”Œ ë¡œë“œ
            const loadPromises = samplePaths.map(async (pathObj) => {
                try {
                    const audio = new Audio(pathObj.safePath);
                    audio.preload = 'auto';
                    audio.volume = 0.7;
                    return { path: pathObj.originalPath, audio }; // ì›ë˜ ê²½ë¡œë¡œ ì €ì¥
                } catch (error) {
                    console.log(`Failed to load: ${pathObj.safePath}`);
                    return null;
                }
            });
            
            const results = await Promise.allSettled(loadPromises);
            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    audioPool.samples.set(result.value.path, result.value.audio);
                }
            });
            
            console.log(`Loaded ${audioPool.samples.size} samples for ${instrument}`);
        }

        // ë“œëŸ¼ ìƒ˜í”Œ í”„ë¦¬ë¡œë“œ
        async function preloadDrumSamples() {
            const drumTypes = ['kick', 'snare', 'hihat', 'crash'];
            
            const loadPromises = drumTypes.map(async (drumType) => {
                try {
                    const audio = new Audio(`sounds/drums/${drumType}.wav`);
                    audio.preload = 'auto';
                    audio.volume = 0.7;
                    return { path: `sounds/drums/${drumType}.wav`, audio };
                } catch (error) {
                    console.log(`Failed to load drum sample: ${drumType}.wav`);
                    return null;
                }
            });
            
            const results = await Promise.allSettled(loadPromises);
            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value) {
                    audioPool.samples.set(result.value.path, result.value.audio);
                }
            });
            
            console.log(`Loaded ${results.filter(r => r.status === 'fulfilled' && r.value).length} drum samples`);
        }

        // ëª¨ë“  ìŒì› í”„ë¦¬ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
        async function preloadAllSamples() {
            const instruments = ['piano', 'bass4', 'bass5'];
            
            for (const instrument of instruments) {
                await preloadAudioSamples(instrument);
            }
            
            // ë“œëŸ¼ ìƒ˜í”Œë„ ë¡œë“œ
            await preloadDrumSamples();
            
            console.log('All samples preloaded');
        }

        // ê°œì„ ëœ ì•…ê¸° ì†Œë¦¬ ì¬ìƒ ì‹œìŠ¤í…œ (í•©ì„±ìŒë§Œ ì‚¬ìš©)
        async function playInstrumentNote(note, octave, instrument = currentInstrument, duration = 500) {
            const trackingKey = `${instrument}_${note}${octave}`;
            
            // 1ë‹¨ê³„: ì´ì „ì— ì¬ìƒ ì¤‘ì¸ ê°™ì€ ìŒ ì •ì§€ (ë¶ˆí˜‘í™”ìŒ ë°©ì§€)
            if (audioPool.playingSounds.has(trackingKey)) {
                const prevSound = audioPool.playingSounds.get(trackingKey);
                if (prevSound.oscillator) {
                    try {
                        prevSound.oscillator.stop();
                    } catch (e) {
                        // ì´ë¯¸ ì •ì§€ëœ ê²½ìš° ë¬´ì‹œ
                    }
                }
                audioPool.playingSounds.delete(trackingKey);
            }
            
            // 2ë‹¨ê³„: í´ë¦¬í¬ë‹ˆ ì œí•œ (CPU ë¶€í•˜ ë°©ì§€)
            if (audioPool.playingSounds.size >= audioPool.maxPolyphony) {
                // ê°€ì¥ ì˜¤ë˜ëœ ì‚¬ìš´ë“œ ì •ì§€
                const oldestKey = audioPool.playingSounds.keys().next().value;
                const oldestSound = audioPool.playingSounds.get(oldestKey);
                if (oldestSound.oscillator) {
                    try {
                        oldestSound.oscillator.stop();
                    } catch (e) {}
                }
                audioPool.playingSounds.delete(oldestKey);
            }
            
            // í•©ì„±ìŒìœ¼ë¡œ ì¬ìƒ
            playInstrumentNoteSynthetic(note, octave, instrument, duration, trackingKey);
        }

        // í•©ì„±ìŒ ì¬ìƒ (Web Audio API)
        function playInstrumentNoteSynthetic(note, octave, instrument, duration, trackingKey) {
            if (!audioContext) return;
            
            const frequency = getNoteFrequency(note, octave);
            
            // ì•…ê¸°ë³„ ìŒìƒ‰ ì„¤ì •
            let waveType = 'sine';
            let baseVolume = 0.3;
            const instrumentVol = document.getElementById('instrumentVolume').value / 100;
            
            switch (instrument) {
                case 'guitar':
                    waveType = 'sawtooth';
                    baseVolume = 0.4;
                    break;
                case 'bass4':
                case 'bass5':
                    waveType = 'sawtooth';
                    baseVolume = 0.5;
                    break;
                case 'violin':
                    waveType = 'triangle';
                    baseVolume = 0.3;
                    break;
            }
            
            const finalVolume = baseVolume * instrumentVol;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = waveType;
            
            // ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œ ì¸/ì•„ì›ƒìœ¼ë¡œ í´ë¦­ ë…¸ì´ì¦ˆ ë°©ì§€
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(finalVolume, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            // ì¬ìƒ ì¶”ì 
            audioPool.playingSounds.set(trackingKey, { oscillator, startTime: Date.now() });
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
            
            // ìë™ ì •ë¦¬
            oscillator.addEventListener('ended', () => {
                if (audioPool.playingSounds.has(trackingKey)) {
                    audioPool.playingSounds.delete(trackingKey);
                }
            });
        }

        // ëª¨ë“  ì‚¬ìš´ë“œ ì •ì§€ (ê¸´ê¸‰ ì •ì§€ ê¸°ëŠ¥)
        function stopAllSounds() {
            audioPool.playingSounds.forEach((sound, key) => {
                if (sound.audio) {
                    sound.audio.pause();
                    sound.audio.currentTime = 0;
                }
                if (sound.oscillator) {
                    try {
                        sound.oscillator.stop();
                    } catch (e) {}
                }
            });
            audioPool.playingSounds.clear();
        }

        // ë“œëŸ¼ ê·¸ë¦¬ë“œ ìƒì„±
        function createDrumGrid() {
            const drumGrid = document.getElementById('drumGrid');
            
            // í•­ìƒ 16ìŠ¤í…ìœ¼ë¡œ ê³ ì • (16ë¹„íŠ¸ ë“œëŸ¼ë¨¸ì‹ )
            const totalSteps = 16;
            
            // íŒ¨í„´ ë°°ì—´ í¬ê¸° ì¡°ì •
            Object.keys(drumPattern).forEach(drum => {
                drumPattern[drum] = drumPattern[drum].slice(0, totalSteps);
                while (drumPattern[drum].length < totalSteps) {
                    drumPattern[drum].push(false);
                }
            });
            
            drumGrid.innerHTML = '';
            
            const drumLabels = {
                kick: 'í‚¥ë“œëŸ¼',
                snare: 'ìŠ¤ë„¤ì–´',
                hihat: 'í•˜ì´í–‡',
                crash: 'í¬ë˜ì‹œ'
            };
            
            Object.keys(drumPattern).forEach(drumType => {
                const row = document.createElement('div');
                row.className = 'drum-row';
                
                const label = document.createElement('div');
                label.className = 'drum-label';
                label.textContent = drumLabels[drumType];
                row.appendChild(label);
                
                for (let step = 0; step < totalSteps; step++) {
                    const stepEl = document.createElement('div');
                    stepEl.className = 'drum-step';
                    stepEl.setAttribute('data-drum', drumType);
                    stepEl.setAttribute('data-step', step);
                    
                    // ë°•ì í‘œì‹œ (4ìŠ¤í…ë§ˆë‹¤ = 4ë¶„ìŒí‘œë§ˆë‹¤)
                    if (step % 4 === 0) {
                        stepEl.classList.add('beat');
                        stepEl.textContent = Math.floor(step / 4) + 1;
                    }
                    
                    // í™œì„±í™” ìƒíƒœ í‘œì‹œ
                    if (drumPattern[drumType][step]) {
                        stepEl.classList.add('active');
                    }
                    
                    stepEl.addEventListener('click', () => {
                        drumPattern[drumType][step] = !drumPattern[drumType][step];
                        stepEl.classList.toggle('active');
                        
                        // í´ë¦­ ì‹œ í•´ë‹¹ ë“œëŸ¼ ì†Œë¦¬ ì¬ìƒ
                        if (drumPattern[drumType][step]) {
                            playDrumSoundImproved(drumType, step);
                        }
                    });
                    
                    row.appendChild(stepEl);
                }
                
                drumGrid.appendChild(row);
            });
        }

        // ë“œëŸ¼ íŒ¨í„´ í”„ë¦¬ì…‹ ë¡œë“œ
        function loadDrumPreset(presetName) {
            const presets = {
                rock: {
                    kick: [1,0,0,0, 0,0,1,0, 1,0,0,0, 0,0,1,0],
                    snare: [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
                    hihat: [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
                    crash: [1,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
                },
                pop: {
                    kick: [1,0,0,0, 0,0,1,0, 1,0,0,0, 0,0,0,0],
                    snare: [0,0,0,0, 1,0,0,1, 0,0,0,0, 1,0,0,0],
                    hihat: [1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1],
                    crash: [1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0]
                },
                funk: {
                    kick: [1,0,0,1, 0,0,1,0, 0,1,0,0, 1,0,0,0],
                    snare: [0,0,0,0, 1,0,0,1, 0,0,0,0, 1,0,1,0],
                    hihat: [1,0,1,1, 0,1,0,1, 1,0,1,1, 0,1,0,1],
                    crash: [1,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0]
                }
            };
            
            if (presets[presetName]) {
                Object.keys(presets[presetName]).forEach(drum => {
                    drumPattern[drum] = presets[presetName][drum].map(x => Boolean(x));
                });
                createDrumGrid();
            }
        }

        // ë“œëŸ¼ íŒ¨í„´ í´ë¦¬ì–´
        function clearDrumPattern() {
            Object.keys(drumPattern).forEach(drum => {
                drumPattern[drum].fill(false);
            });
            createDrumGrid();
        }

        // ë“œëŸ¼ íŒ¨í„´ ì¬ìƒ ì‹œìŠ¤í…œ ê°œì„ 
        let drumTimeouts = []; // ì˜ˆì•½ëœ ë“œëŸ¼ ì‚¬ìš´ë“œ ì¶”ì 
        let drumPlayingSounds = new Map(); // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë“œëŸ¼ ì‚¬ìš´ë“œ ì¶”ì 
        
        // ëª¨ë“  ë“œëŸ¼ ì‚¬ìš´ë“œ ì¦‰ì‹œ ì •ì§€
        function stopAllDrumSounds() {
            // ì˜ˆì•½ëœ íƒ€ì„ì•„ì›ƒ ëª¨ë‘ ì·¨ì†Œ
            drumTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
            drumTimeouts = [];
            
            // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë“œëŸ¼ ì‚¬ìš´ë“œ ì •ì§€
            drumPlayingSounds.forEach((audio, key) => {
                if (audio && !audio.paused) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            });
            drumPlayingSounds.clear();
            
            // ë“œëŸ¼ ìŠ¤í… í‘œì‹œ ì œê±°
            const allSteps = document.querySelectorAll('.drum-step');
            allSteps.forEach(step => step.classList.remove('current'));
        }
        
        // ë“œëŸ¼ íŒ¨í„´ ì¬ìƒ (ë©”íŠ¸ë¡œë†ˆê³¼ ì—°ë™) - 16ë¹„íŠ¸ = í•œ ë§ˆë””ë¥¼ 16ë¶„ìŒí‘œë¡œ
        function playDrumPattern(step) {
            // 16ìŠ¤í… ë²”ìœ„ ë‚´ì—ì„œë§Œ ì¬ìƒ (í•œ ë§ˆë”” = 16ë¶„ìŒí‘œ 16ê°œ)
            if (step >= 0 && step < 16) {
                Object.keys(drumPattern).forEach(drumType => {
                    if (drumPattern[drumType][step]) {
                        playDrumSoundImproved(drumType, step);
                    }
                });
                
                // í˜„ì¬ ìŠ¤í… í‘œì‹œ ì—…ë°ì´íŠ¸
                updateDrumStepIndicator(step);
            }
        }

        // ë“œëŸ¼ ìŠ¤í… í‘œì‹œê¸° ì—…ë°ì´íŠ¸ - ì •í™•í•œ ìŠ¤í… ì¶”ì 
        function updateDrumStepIndicator(currentStep) {
            // ì´ì „ í‘œì‹œ ëª¨ë‘ ì œê±°
            const allSteps = document.querySelectorAll('.drum-step');
            allSteps.forEach(step => step.classList.remove('current'));
            
            // í˜„ì¬ ìŠ¤í…ë§Œ í‘œì‹œ (ëª¨ë“  ë“œëŸ¼ íƒ€ì…ì—ì„œ)
            const currentSteps = document.querySelectorAll(`[data-step="${currentStep}"]`);
            currentSteps.forEach(step => step.classList.add('current'));
            
            // 16ë¶„ìŒí‘œ ê¸¸ì´ë§Œí¼ í‘œì‹œ í›„ ì œê±°
            const bpm = parseInt(document.getElementById('bpm').value);
            const sixteenthDuration = 60000 / bpm / 4;
            
            setTimeout(() => {
                const stepsToRemove = document.querySelectorAll(`[data-step="${currentStep}"].current`);
                stepsToRemove.forEach(step => step.classList.remove('current'));
            }, sixteenthDuration * 0.8); // ì•½ê°„ ì§§ê²Œ í‘œì‹œ
        }

        // ì•…ê¸° ë³€ê²½ í•¨ìˆ˜
        function switchInstrument() {
            const selectedInstrument = document.getElementById('instrumentSelect').value;
            const mainTitle = document.getElementById('mainTitle');
            const fretboardTitle = document.getElementById('fretboardTitle');
            const fretboardModeDiv = document.getElementById('fretboardModeDiv');
            const violinModeDiv = document.getElementById('violinModeDiv');
            
            // ì´ì „ ì•…ê¸°ì˜ ëª¨ë“  ì‚¬ìš´ë“œ ì •ì§€
            stopAllSounds();
            
            currentInstrument = selectedInstrument;
            
            switch (selectedInstrument) {
                case 'guitar':
                    stringTuning = guitarTuning;
                    mainTitle.textContent = 'ğŸµ ScaleFlow';
                    fretboardTitle.textContent = 'ê¸°íƒ€ í”„ë ›ë³´ë“œ';
                    fretboardModeDiv.style.display = 'flex';
                    violinModeDiv.style.display = 'none';
                    break;
                case 'bass4':
                    stringTuning = bass4Tuning;
                    mainTitle.textContent = 'ğŸµ ScaleFlow';
                    fretboardTitle.textContent = '4í˜„ ë² ì´ìŠ¤ í”„ë ›ë³´ë“œ';
                    fretboardModeDiv.style.display = 'flex';
                    violinModeDiv.style.display = 'none';
                    break;
                case 'bass5':
                    stringTuning = bass5Tuning;
                    mainTitle.textContent = 'ğŸµ ScaleFlow';
                    fretboardTitle.textContent = '5í˜„ ë² ì´ìŠ¤ í”„ë ›ë³´ë“œ';
                    fretboardModeDiv.style.display = 'flex';
                    violinModeDiv.style.display = 'none';
                    break;
                case 'violin':
                    stringTuning = violinTuning;
                    mainTitle.textContent = 'ğŸµ ScaleFlow';
                    fretboardTitle.textContent = 'ë°”ì´ì˜¬ë¦° ì§€íŒ';
                    fretboardModeDiv.style.display = 'none';
                    violinModeDiv.style.display = 'flex';
                    break;
            }
            
            // ìƒˆ ì•…ê¸°ì˜ ìƒ˜í”Œ í”„ë¦¬ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ)
            preloadAudioSamples(selectedInstrument);
            
            createFretboard();
        }

        // í”„ë ›ë³´ë“œ/ì§€íŒ ìƒì„±
        function createFretboard() {
            const fretboard = document.getElementById('fretboard');
            fretboard.innerHTML = '';
            
            const fretboardWidth = 1100;
            const stringCount = stringTuning.length;
            const fretboardHeight = stringCount === 4 ? 120 : (stringCount === 5 ? 150 : 200);
            const fretWidth = fretboardWidth / 23; // 0í”„ë › + 22í”„ë ›
            const stringSpacing = 25;
            
            fretboard.style.width = fretboardWidth + 'px';
            fretboard.style.height = fretboardHeight + 'px';
            
            // í˜„ ê·¸ë¦¬ê¸°
            for (let string = 0; string < stringCount; string++) {
                const stringEl = document.createElement('div');
                stringEl.className = currentInstrument === 'violin' ? 'violin-string' : 'string';
                stringEl.style.position = 'absolute';
                stringEl.style.top = (30 + string * stringSpacing) + 'px';
                stringEl.style.left = '0px';
                stringEl.style.width = '100%';
                fretboard.appendChild(stringEl);
            }
            
            if (currentInstrument === 'guitar' || currentInstrument === 'bass4' || currentInstrument === 'bass5') {
                // ê¸°íƒ€/ë² ì´ìŠ¤ í”„ë › ê·¸ë¦¬ê¸°
                const fretHeight = stringCount <= 5 ? (stringCount === 4 ? 100 : 125) : 160; // ë² ì´ìŠ¤ëŠ” ë” ì‘ê²Œ
                const markerTop = stringCount <= 5 ? (stringCount === 4 ? 140 : 165) : 190;
                
                for (let fret = 1; fret <= 22; fret++) {
                    const fretEl = document.createElement('div');
                    fretEl.className = 'fret';
                    fretEl.style.position = 'absolute';
                    fretEl.style.left = (fret * fretWidth) + 'px';
                    fretEl.style.top = '20px';
                    fretEl.style.height = fretHeight + 'px';
                    fretboard.appendChild(fretEl);
                    
                    // í”„ë › ë§ˆì»¤ (ì¸ë ˆì´)
                    if ([3, 5, 7, 9, 15, 17, 19].includes(fret)) {
                        const marker = document.createElement('div');
                        marker.className = 'fret-marker';
                        marker.style.left = (fret * fretWidth - fretWidth/2 - 4) + 'px';
                        marker.style.top = markerTop + 'px';
                        fretboard.appendChild(marker);
                    } else if (fret === 12) {
                        // 12í”„ë ›ì€ ë‘ ê°œì˜ ë§ˆì»¤
                        const marker1 = document.createElement('div');
                        marker1.className = 'fret-marker double';
                        marker1.style.left = (fret * fretWidth - fretWidth/2 - 8) + 'px';
                        marker1.style.top = markerTop + 'px';
                        fretboard.appendChild(marker1);
                        
                        const marker2 = document.createElement('div');
                        marker2.className = 'fret-marker double';
                        marker2.style.left = (fret * fretWidth - fretWidth/2 + 2) + 'px';
                        marker2.style.top = markerTop + 'px';
                        fretboard.appendChild(marker2);
                    }
                }
            } else {
                // ë°”ì´ì˜¬ë¦° í¬ì§€ì…˜ ë§ˆì»¤ (í”„ë › ëŒ€ì‹  ìœ„ì¹˜ ê°€ì´ë“œ)
                const positions = [3, 5, 7, 9, 12, 15, 17, 19]; // ì£¼ìš” í¬ì§€ì…˜ë“¤
                positions.forEach(pos => {
                    const marker = document.createElement('div');
                    marker.className = 'position-marker';
                    marker.style.left = (pos * fretWidth) + 'px';
                    marker.style.top = '20px';
                    marker.style.height = (stringCount * stringSpacing + 20) + 'px';
                    fretboard.appendChild(marker);
                });
            }
            
            updateScale();
        }

        // ìŒí‘œ ì¸ë±ìŠ¤ ê³„ì‚°
        function getNoteIndex(note) {
            return notes.indexOf(note);
        }

        // í”„ë ›/í¬ì§€ì…˜ì˜ ìŒí‘œì™€ ì˜¥íƒ€ë¸Œ ê³„ì‚°
        function getFretNote(stringIndex, fret) {
            const openString = stringTuning[stringIndex];
            const openNote = openString.note;
            const openOctave = openString.octave;
            const openNoteIndex = getNoteIndex(openNote);
            
            const totalSemitones = openNoteIndex + fret;
            const noteIndex = totalSemitones % 12;
            const octaveOffset = Math.floor(totalSemitones / 12);
            
            return {
                note: notes[noteIndex],
                octave: openOctave + octaveOffset
            };
        }

        // ìŠ¤ì¼€ì¼ ì—…ë°ì´íŠ¸
        function updateScale() {
            const keyCenter = document.getElementById('keyCenter').value;
            const scaleType = document.getElementById('scaleType').value;
            const fretboard = document.getElementById('fretboard');
            
            // í˜„ì¬ ì•…ê¸°ì— ë”°ë¥¸ ëª¨ë“œ í™•ì¸
            let isRealMode;
            if (currentInstrument === 'guitar' || currentInstrument === 'bass4' || currentInstrument === 'bass5') {
                isRealMode = document.getElementById('fretboardMode').checked;
            } else {
                isRealMode = document.getElementById('violinMode').checked;
            }
            
            // ê¸°ì¡´ ìŠ¤ì¼€ì¼ ë…¸íŠ¸ ì œê±°
            const existingNotes = fretboard.querySelectorAll('.scale-note');
            existingNotes.forEach(note => note.remove());
            
            const pattern = scalePatterns[scaleType];
            const intervals = scaleIntervals[scaleType];
            const keyCenterIndex = getNoteIndex(keyCenter);
            const fretWidth = 1100 / 23;
            const stringCount = stringTuning.length;
            const stringSpacing = 25;
            
            // ìŠ¤ì¼€ì¼ ë…¸íŠ¸ë“¤ ê³„ì‚°
            const scaleNotes = pattern.map(interval => notes[(keyCenterIndex + interval) % 12]);
            
            // ê° í˜„ê³¼ í”„ë ›/í¬ì§€ì…˜ì— ëŒ€í•´ ìŠ¤ì¼€ì¼ ë…¸íŠ¸ í‘œì‹œ
            for (let string = 0; string < stringCount; string++) {
                for (let fret = 0; fret <= 22; fret++) {
                    let displayString;
                    if (currentInstrument === 'guitar' || currentInstrument === 'bass4' || currentInstrument === 'bass5') {
                        displayString = isRealMode ? string : (stringCount - 1 - string);
                    } else {
                        // ë°”ì´ì˜¬ë¦°: ì‹¤ë¬¼ëª¨ë“œê°€ ê¸°ë³¸ê°’ì´ë¯€ë¡œ ë°˜ëŒ€ë¡œ ì²˜ë¦¬
                        displayString = isRealMode ? (stringCount - 1 - string) : string;
                    }
                    
                    const fretNoteData = getFretNote(string, fret);
                    const scaleIndex = scaleNotes.indexOf(fretNoteData.note);
                    
                    if (scaleIndex !== -1) {
                        const noteEl = document.createElement('div');
                        noteEl.className = 'scale-note';
                        noteEl.textContent = intervals[scaleIndex];
                        noteEl.style.position = 'absolute';
                        noteEl.style.left = (fret === 0 ? -25 : (fret - 0.5) * fretWidth - 12) + 'px';
                        noteEl.style.top = (18 + displayString * stringSpacing) + 'px';
                        noteEl.style.backgroundColor = intervalColors[intervals[scaleIndex]];
                        noteEl.style.zIndex = '10';
                        
                        noteEl.addEventListener('click', () => {
                            // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” (ì²« í´ë¦­ì—ì„œ)
                            initAudio();
                            // í”„ë ›ë³´ë“œëŠ” í•©ì„±ìŒìœ¼ë¡œë§Œ ì¬ìƒ
                            const frequency = getNoteFrequency(fretNoteData.note, fretNoteData.octave);
                            const trackingKey = `fretboard_${fretNoteData.note}${fretNoteData.octave}`;
                            playInstrumentNoteSynthetic(fretNoteData.note, fretNoteData.octave, currentInstrument, 400, trackingKey);
                        });
                        
                        fretboard.appendChild(noteEl);
                    }
                }
            }
        }

        // ë°•ì í‘œì‹œê¸° ì—…ë°ì´íŠ¸
        function updateBeatIndicators() {
            const timeSignature = document.getElementById('timeSignature').value;
            const [numerator] = timeSignature.split('/').map(Number);
            beatCount = numerator;
            
            const container = document.getElementById('beatIndicators');
            container.innerHTML = '';
            
            beatStates = new Array(beatCount).fill(true);
            
            for (let i = 0; i < beatCount; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'beat-indicator';
                indicator.textContent = i + 1;
                indicator.addEventListener('click', () => {
                    beatStates[i] = !beatStates[i];
                    indicator.classList.toggle('disabled', !beatStates[i]);
                });
                container.appendChild(indicator);
            }
            
            // ë“œëŸ¼ ê·¸ë¦¬ë“œë„ ì—…ë°ì´íŠ¸
            createDrumGrid();
        }

        // ë©”íŠ¸ë¡œë†ˆ ì¬ìƒ - ì™„ì „íˆ ìƒˆë¡œìš´ ì‹œìŠ¤í…œ
        function startMetronome() {
            if (metronomeInterval) return;
            
            initAudio();
            const bpm = parseInt(document.getElementById('bpm').value);
            const subdivisions = currentSubdivision;
            const isChordMode = document.getElementById('chordMode').checked;
            const soundType = document.getElementById('metronomeSound').value;
            
            // 16ë¶„ìŒí‘œ ê¸°ì¤€ìœ¼ë¡œ í†µì¼ (ê°€ì¥ ì„¸ë°€í•œ ë‹¨ìœ„)
            const sixteenthInterval = 60000 / bpm / 4; // 16ë¶„ìŒí‘œ ê°„ê²©
            let sixteenthCount = 0; // 16ë¶„ìŒí‘œ ì¹´ìš´í„° (0-15 ë°˜ë³µ)
            
            currentBeat = 0;
            currentChordBar = 0;
            currentDrumStep = 0;
            
            // ë°•ì í‘œì‹œê¸° ì´ˆê¸°í™”
            const indicators = document.querySelectorAll('.beat-indicator');
            indicators.forEach(ind => ind.classList.remove('active'));
            
            // ì²« ë°• ì¦‰ì‹œ ì¬ìƒ
            playMetronomeSound(0, soundType, subdivisions, isChordMode);
            
            // ì½”ë“œ ì§„í–‰ ì‹œì‘ (ì½”ë“œ ëª¨ë“œì¼ ë•Œ)
            if (isChordMode) {
                startChordProgression();
            }
            
            // 16ë¶„ìŒí‘œ ë‹¨ìœ„ë¡œ ì •í™•í•œ íƒ€ì´ë° ì œì–´
            metronomeInterval = setInterval(() => {
                sixteenthCount = (sixteenthCount + 1) % 16; // 0-15 ìˆœí™˜
                
                // ë©”íŠ¸ë¡œë†ˆ ì†Œë¦¬ ì¬ìƒ (ëª¨ë“  16ë¶„ìŒí‘œì—ì„œ ì²´í¬)
                playMetronomeSound(sixteenthCount, soundType, subdivisions, isChordMode);
                
                // ë°•ì í‘œì‹œê¸° ì—…ë°ì´íŠ¸ (4ë¶„ìŒí‘œë§ˆë‹¤)
                const currentQuarterBeat = Math.floor(sixteenthCount / 4); // 0, 1, 2, 3
                const sixteenthInBeat = sixteenthCount % 4; // ë°•ì ë‚´ 16ë¶„ìŒí‘œ ìœ„ì¹˜
                
                if (sixteenthInBeat === 0) {
                    indicators.forEach(ind => ind.classList.remove('active'));
                    if (beatStates[currentQuarterBeat]) {
                        indicators[currentQuarterBeat].classList.add('active');
                    }
                }
                
            }, sixteenthInterval);
        }
        
        // ë©”íŠ¸ë¡œë†ˆ ì†Œë¦¬ ì¬ìƒ ë¡œì§ ë¶„ë¦¬
        function playMetronomeSound(sixteenthCount, soundType, subdivisions, isChordMode) {
            const currentQuarterBeat = Math.floor(sixteenthCount / 4);
            const sixteenthInBeat = sixteenthCount % 4;
            
            // ë¹„í™œì„±í™”ëœ ë°•ìëŠ” ê±´ë„ˆë›°ê¸° (ë“œëŸ¼ íŒ¨í„´ ì œì™¸)
            if (soundType !== 'pattern' && !beatStates[currentQuarterBeat]) return;
            
            let shouldPlay = false;
            let isDownbeat = false;
            let isFirstBeat = false;
            
            // ë“œëŸ¼ íŒ¨í„´ì€ í•­ìƒ ì¬ìƒ (ëª¨ë“  16ë¶„ìŒí‘œì—ì„œ)
            if (soundType === 'pattern') {
                playDrumPattern(sixteenthCount);
                return; // ë“œëŸ¼ íŒ¨í„´ì¼ ë•ŒëŠ” ë‹¤ë¥¸ ì†Œë¦¬ ì¬ìƒí•˜ì§€ ì•ŠìŒ
            }
            
            // ì¬ìƒ ì˜µì…˜ì— ë”°ë¥¸ ì†Œë¦¬ ì¬ìƒ ê²°ì •
            switch (subdivisions) {
                case 'quarter':
                    shouldPlay = sixteenthInBeat === 0; // 4ë¶„ìŒí‘œë§ˆë‹¤
                    isDownbeat = true;
                    break;
                case 'eighth':
                    shouldPlay = sixteenthInBeat === 0 || sixteenthInBeat === 2; // 8ë¶„ìŒí‘œë§ˆë‹¤
                    isDownbeat = sixteenthInBeat === 0;
                    break;
                case 'triplet':
                    // 3ì—°ìŒí‘œ: 0, 1.33, 2.67 ìœ„ì¹˜ (16ë¶„ìŒí‘œë¡œ ê·¼ì‚¬: 0, 1, 3)
                    shouldPlay = sixteenthInBeat === 0 || sixteenthInBeat === 1 || sixteenthInBeat === 3;
                    isDownbeat = sixteenthInBeat === 0;
                    break;
                case 'tripletGhost':
                    // 3ì—°ìŒí‘œ ê°€ìš´ë° ë¹ˆ: 0, 2.67 ìœ„ì¹˜
                    shouldPlay = sixteenthInBeat === 0 || sixteenthInBeat === 3;
                    isDownbeat = sixteenthInBeat === 0;
                    break;
                case 'sixteenth':
                    shouldPlay = true; // ëª¨ë“  16ë¶„ìŒí‘œ
                    isDownbeat = sixteenthInBeat === 0;
                    break;
                case 'sixteenthSparse':
                    shouldPlay = sixteenthInBeat === 0 || sixteenthInBeat === 3; // 1ë²ˆì§¸, 4ë²ˆì§¸ë§Œ
                    isDownbeat = sixteenthInBeat === 0;
                    break;
            }
            
            isFirstBeat = currentQuarterBeat === 0 && isDownbeat;
            
            if (shouldPlay) {
                if (soundType === 'drum') {
                    if (isFirstBeat) {
                        playDrum('kick', 80);
                    } else if (isDownbeat) {
                        playDrum('snare', 60);
                    } else {
                        playDrum('hihat', 40);
                    }
                } else {
                    if (isFirstBeat) {
                        playBeep(1000, 50);
                    } else if (isDownbeat) {
                        playBeep(900, 50);
                    } else {
                        playBeep(800, 50);
                    }
                }
                
                // ì²« ë°•ì—ì„œ ì½”ë“œ ì¬ìƒ (ì½”ë“œ ëª¨ë“œì¼ ë•Œ)
                if (isFirstBeat && isChordMode && sixteenthCount === 0) {
                    playChordSound(chordProgression[0]);
                }
            }
        }

        // ë©”íŠ¸ë¡œë†ˆ ì •ì§€
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
                currentBeat = 0;
                
                const indicators = document.querySelectorAll('.beat-indicator');
                indicators.forEach(ind => ind.classList.remove('active'));
                
                // ëª¨ë“  ë“œëŸ¼ ì‚¬ìš´ë“œ ì¦‰ì‹œ ì •ì§€
                stopAllDrumSounds();
            }
            
            // ì½”ë“œ ì§„í–‰ë„ í•¨ê»˜ ì •ì§€
            stopChordProgression();
        }

        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        function updateTimerDisplay() {
            const timerType = document.getElementById('timerType').value;
            const display = document.getElementById('timerDisplay');
            
            if (timerType === 'time') {
                const minutes = Math.floor(timerSeconds / 60);
                const seconds = timerSeconds % 60;
                display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display.textContent = `${timerBars} ì†Œì ˆ`;
            }
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            const timerType = document.getElementById('timerType').value;
            
            if (timerType === 'time') {
                timerSeconds = parseInt(document.getElementById('timeTimer').value) * 60;
            } else {
                timerBars = parseInt(document.getElementById('barsTimer').value);
            }
            
            updateTimerDisplay();
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (timerType === 'time') {
                    timerSeconds--;
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        playBeep(1200, 500); // ì™„ë£Œ ì‹ í˜¸
                    }
                } else {
                    // ì†Œì ˆ íƒ€ì´ë¨¸ëŠ” ë©”íŠ¸ë¡œë†ˆê³¼ ì—°ë™í•˜ì—¬ ê³„ì‚°
                    const bpm = parseInt(document.getElementById('bpm').value);
                    const timeSignature = document.getElementById('timeSignature').value;
                    const [numerator] = timeSignature.split('/').map(Number);
                    const barDuration = (60000 / bpm) * numerator;
                    
                    // ê°„ë‹¨íˆ 1ì´ˆë§ˆë‹¤ ì²´í¬
                    if (metronomeInterval && currentBeat === 0) {
                        timerBars--;
                        if (timerBars <= 0) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                            playBeep(1200, 500);
                        }
                    }
                }
                updateTimerDisplay();
            }, 1000);
        }

        // ì½”ë“œ ì§„í–‰ ì¬ìƒ
        function startChordProgression() {
            if (chordInterval) return;
            
            const bpm = parseInt(document.getElementById('bpm').value);
            const beatDuration = 60000 / bpm;
            
            currentChordIndex = 0;
            currentChordBeat = 0;
            
            // ì²« ì½”ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateCurrentChordDisplay();
            
            // ì²« ì½”ë“œëŠ” ë©”íŠ¸ë¡œë†ˆì—ì„œ ì´ë¯¸ ì¬ìƒí–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” íƒ€ì´ë¨¸ë§Œ ì„¤ì •
            chordInterval = setInterval(() => {
                currentChordBeat++;
                
                // í˜„ì¬ ì½”ë“œì˜ ì§€ì†ì‹œê°„ì´ ëë‚¬ëŠ”ì§€ í™•ì¸
                if (currentChordBeat >= chordProgression[currentChordIndex].duration) {
                    currentChordIndex = (currentChordIndex + 1) % chordProgression.length;
                    currentChordBeat = 0;
                    playChordSound(chordProgression[currentChordIndex]);
                    updateCurrentChordDisplay();
                }
            }, beatDuration);
        }
        
        // í˜„ì¬ ì—°ì£¼ ì¤‘ì¸ ì½”ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCurrentChordDisplay() {
            // ì„¤ì • íŒ¨ë„ì˜ í˜„ì¬ ì½”ë“œ í‘œì‹œ ì—…ë°ì´íŠ¸
            const currentChordDisplay = document.getElementById('currentChordDisplay');
            if (currentChordDisplay) {
                currentChordDisplay.textContent = getChordName(chordProgression[currentChordIndex]);
            }
            
            // ì½”ë“œ ì§„í–‰ í‘œì‹œì—ì„œ í˜„ì¬ ì½”ë“œ í•˜ì´ë¼ì´íŠ¸
            const chordItems = document.querySelectorAll('.chord-item');
            chordItems.forEach((item, index) => {
                if (index === currentChordIndex) {
                    item.classList.add('playing');
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        // ì½”ë“œ êµ¬ì„±ìŒ ê³„ì‚°
        function getChordNotes(chordObj) {
            const { root, quality, seventh, tensions } = chordObj;
            const rootIndex = getNoteIndex(root);
            let intervals = [];
            
            // ê¸°ë³¸ íŠ¸ë¼ì´ì–´ë“œ
            switch (quality) {
                case 'major':
                    intervals = [0, 4, 7]; // 1, 3, 5
                    break;
                case 'minor':
                    intervals = [0, 3, 7]; // 1, b3, 5
                    break;
                case 'augmented':
                    intervals = [0, 4, 8]; // 1, 3, #5
                    break;
                case 'diminished':
                    intervals = [0, 3, 6]; // 1, b3, b5
                    break;
                case 'halfDiminished':
                    intervals = [0, 3, 6]; // 1, b3, b5 (í•˜í”„ë””ë¯¸ë‹ˆì‹œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ m7b5)
                    break;
            }
            
            // ì„¸ë¸ìŠ¤ ì¶”ê°€
            if (seventh === 'dominant') {
                intervals.push(10); // b7
            } else if (seventh === 'major7') {
                intervals.push(11); // 7
            }
            
            // ë””ë¯¸ë‹ˆì‹œì™€ í•˜í”„ë””ë¯¸ë‹ˆì‹œì˜ ê¸°ë³¸ ì„¸ë¸ìŠ¤ ì²˜ë¦¬
            if (quality === 'diminished' && seventh === '') {
                intervals.push(9); // bb7 (ë””ë¯¸ë‹ˆì‹œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë”ë¸”í”Œë«7)
            } else if (quality === 'halfDiminished' && seventh === '') {
                intervals.push(10); // b7 (í•˜í”„ë””ë¯¸ë‹ˆì‹œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ m7b5)
            }
            
            // í…ì…˜ ì¶”ê°€
            tensions.forEach(tension => {
                switch (tension) {
                    case '9': intervals.push(2); break;
                    case 'b9': intervals.push(1); break;
                    case '#9': intervals.push(3); break;
                    case '11': intervals.push(5); break;
                    case '#11': intervals.push(6); break;
                    case '13': intervals.push(9); break;
                    case 'b13': intervals.push(8); break;
                }
            });
            
            // ìŒí‘œë¡œ ë³€í™˜ (í•œ ì˜¥íƒ€ë¸Œ ë‚´ì—ì„œ)
            return intervals.map(interval => notes[(rootIndex + interval) % 12]);
        }
        
        // í”¼ì•„ë…¸ ë³´ì´ì‹± ìƒì„± (C3-B4 ë²”ìœ„ ë‚´ì—ì„œ)
        function createPianoVoicing(chordNotes) {
            const voicing = [];
            
            // ê¸°ë³¸ ì „ëµ: ë£¨íŠ¸ì™€ 5ë„ëŠ” ë‚®ì€ ì˜¥íƒ€ë¸Œ(3ì˜¥íƒ€ë¸Œ), 3ë„ì™€ í…ì…˜ì€ ë†’ì€ ì˜¥íƒ€ë¸Œ(4ì˜¥íƒ€ë¸Œ)
            chordNotes.forEach((note, index) => {
                let octave;
                
                if (index === 0) {
                    // ë£¨íŠ¸ëŠ” 3ì˜¥íƒ€ë¸Œ (ë² ì´ìŠ¤ì™€ êµ¬ë¶„)
                    octave = 3;
                } else if (index === 1) {
                    // 3ë„ëŠ” 4ì˜¥íƒ€ë¸Œ (ì„ ëª…í•˜ê²Œ)
                    octave = 4;
                } else if (index === 2) {
                    // 5ë„ëŠ” 3ì˜¥íƒ€ë¸Œ (ë£¨íŠ¸ì™€ í•¨ê»˜)
                    octave = 3;
                } else {
                    // 7ë„ì™€ í…ì…˜ë“¤ì€ 4ì˜¥íƒ€ë¸Œ (ìƒë‹¨ì— ë°°ì¹˜)
                    octave = 4;
                }
                
                // C3-B4 ë²”ìœ„ í™•ì¸ ë° ì¡°ì •
                const noteIndex = notes.indexOf(note);
                if (octave === 3 && noteIndex < notes.indexOf('C')) {
                    octave = 4; // C3ë³´ë‹¤ ë‚®ìœ¼ë©´ 4ì˜¥íƒ€ë¸Œë¡œ
                } else if (octave === 4 && noteIndex > notes.indexOf('B')) {
                    octave = 3; // B4ë³´ë‹¤ ë†’ìœ¼ë©´ 3ì˜¥íƒ€ë¸Œë¡œ
                }
                
                voicing.push({ note, octave });
            });
            
            return voicing;
        }
        
        // ì½”ë“œ ì‚¬ìš´ë“œ ì¬ìƒ (ë² ì´ìŠ¤ + í”¼ì•„ë…¸)
        function playChordSound(chordObj) {
            if (!audioContext) return;
            
            const chordNotes = getChordNotes(chordObj);
            
            // ë² ì´ìŠ¤ ìŒ ì¬ìƒ - E1~D#2 ë²”ìœ„ ë‚´ì—ì„œ ê°€ì¥ ì ì ˆí•œ ì˜¥íƒ€ë¸Œ ì„ íƒ
            let bassOctave = 1;
            const rootNote = chordObj.root;
            const rootIndex = notes.indexOf(rootNote);
            
            // E1ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ Eë³´ë‹¤ ë‚®ì€ ìŒë“¤(C, C#, D, D#)ì€ 2ì˜¥íƒ€ë¸Œë¡œ
            if (rootIndex < notes.indexOf('E')) {
                bassOctave = 2;
            }
            
            const rootFreq = getNoteFrequency(rootNote, bassOctave);
            
            // ë² ì´ìŠ¤ ìŒ ì¬ìƒ (ìŒí‘œ ì •ë³´ í¬í•¨)
            playBass(rootFreq, 800, rootNote, bassOctave);
            
            // í”¼ì•„ë…¸ ì½”ë“œ ì¬ìƒ (ìŠ¤ë§ˆíŠ¸ ë³´ì´ì‹±)
            const voicing = createPianoVoicing(chordNotes);
            voicing.forEach((noteData, index) => {
                setTimeout(() => {
                    const freq = getNoteFrequency(noteData.note, noteData.octave);
                    playPianoNote(freq, 600, noteData.note, noteData.octave);
                }, index * 50); // ì•½ê°„ì˜ ë”œë ˆì´ë¡œ ì•„ë¥´í˜ì§€ì˜¤ íš¨ê³¼
            });
        }
        
        // í”¼ì•„ë…¸ ìŒ ì¬ìƒ (ìŒì› ìš°ì„ , ì—†ìœ¼ë©´ í•©ì„±ìŒ)
        async function playPianoNote(frequency, duration = 500, note = null, octave = null) {
            // ì£¼íŒŒìˆ˜ì—ì„œ ìŒí‘œì™€ ì˜¥íƒ€ë¸Œ ì¶”ì¶œ (ì œê³µë˜ì§€ ì•Šì€ ê²½ìš°)
            if (!note || !octave) {
                const noteData = frequencyToNote(frequency);
                note = noteData.note;
                octave = noteData.octave;
            }
            
            // C3-B4 ë²”ìœ„ ë‚´ë¡œ ì œí•œ
            if (octave < 3) octave = 3;
            if (octave > 4) octave = 4;
            if (octave === 3 && notes.indexOf(note) < notes.indexOf('C')) octave = 4;
            if (octave === 4 && notes.indexOf(note) > notes.indexOf('B')) octave = 3;
            
            // ìŒì› íŒŒì¼ ê²½ë¡œ (ì›ë˜ ê²½ë¡œë¡œ ê²€ìƒ‰)
            const samplePath = `sounds/piano/${note}${octave}.wav`;
            const sample = audioPool.samples.get(samplePath);
            
            if (sample) {
                // ìŒì› íŒŒì¼ë¡œ ì¬ìƒ
                try {
                    const pianoVol = document.getElementById('pianoVolume').value / 100;
                    const clonedAudio = sample.cloneNode();
                    clonedAudio.volume = 0.5 * pianoVol;
                    clonedAudio.currentTime = 0;
                    await clonedAudio.play();
                } catch (error) {
                    console.log(`Failed to play piano sample: ${samplePath}`);
                    // ì‹¤íŒ¨ ì‹œ í•©ì„±ìŒìœ¼ë¡œ ëŒ€ì²´
                    playPianoSynthetic(frequency, duration, note, octave);
                }
            } else {
                // ìŒì›ì´ ì—†ìœ¼ë©´ í•©ì„±ìŒìœ¼ë¡œ ì¬ìƒ
                playPianoSynthetic(frequency, duration, note, octave);
            }
        }
        
        // í”¼ì•„ë…¸ í•©ì„±ìŒ ì¬ìƒ
        function playPianoSynthetic(frequency, duration, note, octave) {
            if (!audioContext) return;
            
            const pianoVol = document.getElementById('pianoVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'triangle';
            
            gainNode.gain.setValueAtTime(0.15 * pianoVol, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }
        
        // ì½”ë“œ ì´ë¦„ ìƒì„±
        function getChordName(chordObj) {
            const { root, quality, seventh, tensions } = chordObj;
            let name = root;
            
            // í€„ë¦¬í‹° í‘œê¸°
            if (quality === 'minor') name += 'm';
            else if (quality === 'augmented') name += '(#5)';
            else if (quality === 'diminished') name += 'Â°';
            else if (quality === 'halfDiminished') name += 'Ã¸';
            
            // ì„¸ë¸ìŠ¤ í‘œê¸°
            if (seventh === 'dominant') {
                name += '7';
            } else if (seventh === 'major7') {
                name += 'â–³7';
            } else if (quality === 'diminished' && seventh === '') {
                name += '7'; // ë””ë¯¸ë‹ˆì‹œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ dim7
            } else if (quality === 'halfDiminished' && seventh === '') {
                name += '7'; // í•˜í”„ë””ë¯¸ë‹ˆì‹œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ m7b5
            }
            
            // í…ì…˜ í‘œê¸°
            if (tensions.length > 0) {
                name += '(' + tensions.join(',') + ')';
            }
            
            return name;
        }

        // ì½”ë“œ UI ìƒì„±
        function createChordElement(chordObj, index) {
            const chordDiv = document.createElement('div');
            chordDiv.className = 'chord-item';
            chordDiv.setAttribute('data-chord-index', index);
            chordDiv.innerHTML = `
                <div class="chord-duration-controls">
                    <div class="control-btn" onclick="adjustChordDuration(${index}, -1)">-</div>
                    <div class="control-btn" onclick="adjustChordDuration(${index}, 1)">+</div>
                </div>
                <div class="chord-controls">
                    <div class="control-btn delete" onclick="deleteChord(${index})">Ã—</div>
                </div>
                <div class="chord-name-display">${getChordName(chordObj)}</div>
                <div class="grid grid-cols-2 gap-1 mb-1">
                    <div>
                        <select class="chord-root w-full input-bg rounded px-1 py-1 text-xs border" onchange="updateChord(${index})">
                            ${notes.map(note => `<option value="${note}" ${note === chordObj.root ? 'selected' : ''}>${note}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <select class="chord-quality w-full input-bg rounded px-1 py-1 text-xs border" onchange="updateChord(${index})">
                            <option value="major" ${chordObj.quality === 'major' ? 'selected' : ''}></option>
                            <option value="minor" ${chordObj.quality === 'minor' ? 'selected' : ''}>m</option>
                            <option value="augmented" ${chordObj.quality === 'augmented' ? 'selected' : ''}>(#5)</option>
                            <option value="diminished" ${chordObj.quality === 'diminished' ? 'selected' : ''}>Â°</option>
                            <option value="halfDiminished" ${chordObj.quality === 'halfDiminished' ? 'selected' : ''}>Ã¸</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-1 mb-1">
                    <div>
                        <select class="chord-seventh w-full input-bg rounded px-1 py-1 text-xs border" onchange="updateChord(${index})">
                            <option value="" ${chordObj.seventh === '' ? 'selected' : ''}>-</option>
                            <option value="dominant" ${chordObj.seventh === 'dominant' ? 'selected' : ''}>7</option>
                            <option value="major7" ${chordObj.seventh === 'major7' ? 'selected' : ''}>â–³7</option>
                        </select>
                    </div>
                    <div>
                        <select class="chord-tension w-full input-bg rounded px-1 py-1 text-xs border" onchange="addTension(${index}, this.value); this.value='';">
                            <option value="">+</option>
                            <option value="9">9</option>
                            <option value="b9">b9</option>
                            <option value="#9">#9</option>
                            <option value="11">11</option>
                            <option value="#11">#11</option>
                            <option value="13">13</option>
                            <option value="b13">b13</option>
                        </select>
                    </div>
                </div>
                <div class="tensions-display text-xs mb-1">
                    ${chordObj.tensions.map(t => `<span class="inline-block bg-blue-100 text-blue-800 px-1 py-0 rounded text-xs cursor-pointer" onclick="removeTension(${index}, '${t}')">${t}Ã—</span>`).join(' ')}
                </div>
                <div class="chord-duration-display text-xs">${chordObj.duration}ë°•</div>
            `;
            return chordDiv;
        }
        
        // ì½”ë“œ ì§„í–‰ UI ì—…ë°ì´íŠ¸
        function updateChordProgressionUI() {
            const container = document.getElementById('chordContainer');
            container.innerHTML = '';
            
            chordProgression.forEach((chord, index) => {
                container.appendChild(createChordElement(chord, index));
            });
        }
        
        // ì½”ë“œ ì—…ë°ì´íŠ¸
        function updateChord(index) {
            const chordDiv = document.querySelectorAll('.chord-item')[index];
            const root = chordDiv.querySelector('.chord-root').value;
            const quality = chordDiv.querySelector('.chord-quality').value;
            const seventh = chordDiv.querySelector('.chord-seventh').value;
            
            chordProgression[index] = {
                ...chordProgression[index],
                root,
                quality,
                seventh
            };
            
            updateChordProgressionUI();
        }
        
        // í…ì…˜ ì¶”ê°€
        function addTension(index, tension) {
            if (tension && !chordProgression[index].tensions.includes(tension)) {
                chordProgression[index].tensions.push(tension);
                updateChordProgressionUI();
            }
        }
        
        // í…ì…˜ ì œê±°
        function removeTension(index, tension) {
            chordProgression[index].tensions = chordProgression[index].tensions.filter(t => t !== tension);
            updateChordProgressionUI();
        }
        
        // ì½”ë“œ ì§€ì†ì‹œê°„ ì¡°ì •
        function adjustChordDuration(index, delta) {
            const newDuration = Math.max(1, chordProgression[index].duration + delta);
            chordProgression[index].duration = newDuration;
            updateChordProgressionUI();
        }
        
        // ì½”ë“œ ì¶”ê°€
        function addChord() {
            chordProgression.push({
                root: 'C',
                quality: 'major',
                seventh: '',
                tensions: [],
                duration: 4
            });
            updateChordProgressionUI();
        }
        
        // ì½”ë“œ ì‚­ì œ
        function deleteChord(index) {
            if (chordProgression.length > 1) {
                chordProgression.splice(index, 1);
                updateChordProgressionUI();
            }
        }

        // ì½”ë“œ ì§„í–‰ ì •ì§€
        function stopChordProgression() {
            if (chordInterval) {
                clearInterval(chordInterval);
                chordInterval = null;
                currentChordIndex = 0;
                currentChordBeat = 0;
                
                // í˜„ì¬ ì½”ë“œ í‘œì‹œ ì´ˆê¸°í™”
                const currentChordDisplay = document.getElementById('currentChordDisplay');
                if (currentChordDisplay) {
                    currentChordDisplay.textContent = '-';
                }
                
                // ëª¨ë“  ì½”ë“œ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                const chordItems = document.querySelectorAll('.chord-item');
                chordItems.forEach(item => {
                    item.classList.remove('playing');
                });
            }
        }

        // í…Œë§ˆ ë³€ê²½ í•¨ìˆ˜
        function toggleTheme() {
            const body = document.getElementById('body');
            const isDark = document.getElementById('darkMode').checked;
            
            if (isDark) {
                body.className = 'dark-theme min-h-screen p-4 transition-colors duration-300';
            } else {
                body.className = 'light-theme min-h-screen p-4 transition-colors duration-300';
            }
        }

        // ìŒí‘œ ì•„ì´ì½˜ ì´ˆê¸°í™”
        function initNoteIcons() {
            const noteIcons = document.querySelectorAll('.note-icon');
            noteIcons.forEach(icon => {
                const noteType = icon.getAttribute('data-note');
                const iconContent = createNoteIcon(noteType);
                icon.innerHTML = iconContent.innerHTML;
            });
        }

        // ì¬ìƒ ì˜µì…˜ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        function handleSubdivisionClick(button) {
            // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.subdivision-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
            button.classList.add('active');
            
            // í˜„ì¬ ì„ íƒëœ ì¬ìƒ ì˜µì…˜ ì—…ë°ì´íŠ¸
            currentSubdivision = button.getAttribute('data-value');
            
            // ë©”íŠ¸ë¡œë†ˆì´ ì¬ìƒ ì¤‘ì´ë©´ ì¦‰ì‹œ ë°˜ì˜
            if (metronomeInterval) {
                stopMetronome();
                startMetronome();
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            createFretboard();
            updateBeatIndicators();
            updateTimerDisplay();
            initNoteIcons();
            updateChordProgressionUI();
            createDrumGrid();
            
            // ëª¨ë“  ìŒì› ë°±ê·¸ë¼ìš´ë“œ í”„ë¦¬ë¡œë“œ ì‹œì‘
            preloadAllSamples();
            
            // ì•…ê¸° ë³€ê²½ ì´ë²¤íŠ¸
            document.getElementById('instrumentSelect').addEventListener('change', switchInstrument);
            
            // ìŠ¤ì¼€ì¼ ë³€ê²½ ì´ë²¤íŠ¸
            document.getElementById('keyCenter').addEventListener('change', updateScale);
            document.getElementById('scaleType').addEventListener('change', updateScale);
            
            // ì§€íŒ ëª¨ë“œ í† ê¸€ (ê¸°íƒ€)
            document.getElementById('fretboardMode').addEventListener('change', updateScale);
            
            // ë°”ì´ì˜¬ë¦° ëª¨ë“œ í† ê¸€
            document.getElementById('violinMode').addEventListener('change', updateScale);
            
            // ë‹¤í¬ëª¨ë“œ í† ê¸€
            document.getElementById('darkMode').addEventListener('change', toggleTheme);
            
            // ì½”ë“œ ëª¨ë“œ í† ê¸€
            document.getElementById('chordMode').addEventListener('change', (e) => {
                const chordProgressionPanel = document.getElementById('chordProgressionPanel');
                
                if (e.target.checked) {
                    chordProgressionPanel.style.display = 'block';
                } else {
                    chordProgressionPanel.style.display = 'none';
                }
            });
            
            // ì½”ë“œ ì¶”ê°€ ë²„íŠ¼
            document.getElementById('addChord').addEventListener('click', addChord);
            
            // ë°•ìí‘œ ë³€ê²½ ì´ë²¤íŠ¸ëŠ” ìœ„ì—ì„œ í†µí•© ì²˜ë¦¬ë¨
            
            // ë©”íŠ¸ë¡œë†ˆ ë²„íŠ¼
            document.getElementById('metronomePlay').addEventListener('click', startMetronome);
            document.getElementById('metronomeStop').addEventListener('click', stopMetronome);
            
            // ì¬ìƒ ì˜µì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.querySelectorAll('.subdivision-btn').forEach(button => {
                button.addEventListener('click', () => handleSubdivisionClick(button));
            });
            
            // BPM ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜
            document.getElementById('bpm').addEventListener('input', () => {
                if (metronomeInterval) {
                    stopMetronome();
                    startMetronome();
                }
            });
            
            // ë©”íŠ¸ë¡œë†ˆ ì‚¬ìš´ë“œ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜
            document.getElementById('metronomeSound').addEventListener('change', () => {
                if (metronomeInterval) {
                    stopMetronome();
                    startMetronome();
                }
            });
            
            // ë°•ìí‘œ ë³€ê²½ ì‹œ ë©”íŠ¸ë¡œë†ˆ ì¬ì‹œì‘ (ë“œëŸ¼ íŒ¨í„´ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸)
            document.getElementById('timeSignature').addEventListener('change', () => {
                updateBeatIndicators();
                if (metronomeInterval) {
                    stopMetronome();
                    startMetronome();
                }
            });
            
            // íƒ€ì´ë¨¸ ì„¤ì •
            document.getElementById('timerType').addEventListener('change', (e) => {
                const timeDiv = document.getElementById('timeTimerDiv');
                const barsDiv = document.getElementById('barsTimerDiv');
                
                if (e.target.value === 'time') {
                    timeDiv.style.display = 'block';
                    barsDiv.style.display = 'none';
                } else {
                    timeDiv.style.display = 'none';
                    barsDiv.style.display = 'block';
                }
                updateTimerDisplay();
            });
            
            document.getElementById('timeTimer').addEventListener('change', updateTimerDisplay);
            document.getElementById('barsTimer').addEventListener('change', updateTimerDisplay);
            document.getElementById('timerStart').addEventListener('click', startTimer);
            
            // ë¦¬ë“¬ íŒ¨ë„ í† ê¸€
            document.getElementById('rhythmToggle').addEventListener('click', () => {
                const panel = document.getElementById('rhythmPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            
            // ìŒëŸ‰ íŒ¨ë„ í† ê¸€
            document.getElementById('volumeToggle').addEventListener('click', () => {
                const panel = document.getElementById('volumePanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            
            // íŒ¨ë„ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', (e) => {
                const rhythmPanel = document.getElementById('rhythmPanel');
                const rhythmToggle = document.getElementById('rhythmToggle');
                const volumePanel = document.getElementById('volumePanel');
                const volumeToggle = document.getElementById('volumeToggle');
                
                if (!rhythmPanel.contains(e.target) && !rhythmToggle.contains(e.target)) {
                    rhythmPanel.style.display = 'none';
                }
                if (!volumePanel.contains(e.target) && !volumeToggle.contains(e.target)) {
                    volumePanel.style.display = 'none';
                }
            });
            
            // ìŒëŸ‰ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
            document.getElementById('metronomeVolume').addEventListener('input', (e) => {
                document.getElementById('metronomeVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('bassVolume').addEventListener('input', (e) => {
                document.getElementById('bassVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('pianoVolume').addEventListener('input', (e) => {
                document.getElementById('pianoVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('instrumentVolume').addEventListener('input', (e) => {
                document.getElementById('instrumentVolumeDisplay').textContent = e.target.value;
            });
            
            // ë“œëŸ¼ ìŒëŸ‰ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
            document.getElementById('drumMasterVolume').addEventListener('input', (e) => {
                document.getElementById('drumMasterVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('kickVolume').addEventListener('input', (e) => {
                document.getElementById('kickVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('snareVolume').addEventListener('input', (e) => {
                document.getElementById('snareVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('hihatVolume').addEventListener('input', (e) => {
                document.getElementById('hihatVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('crashVolume').addEventListener('input', (e) => {
                document.getElementById('crashVolumeDisplay').textContent = e.target.value;
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973b7335b7c3aa7d',t:'MTc1NTk2MDkxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
