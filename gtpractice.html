<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∏∞ÌÉÄ/Î∞îÏù¥Ïò¨Î¶∞ Ïä§ÏºÄÏùº Ïó∞Ïäµ ÎèÑÍµ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fret-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }
        .fret-marker.double {
            width: 6px;
            height: 6px;
        }
        .scale-note {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .scale-note:hover {
            transform: scale(1.1);
        }
        .beat-indicator {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 12px;
        }
        .beat-indicator.active {
            background: #3b82f6;
            border-color: #1d4ed8;
        }
        .beat-indicator.disabled {
            background: #ef4444;
            border-color: #dc2626;
        }
        .string {
            height: 2px;
            background: #8b5cf6;
            position: relative;
        }
        .violin-string {
            height: 3px;
            background: linear-gradient(to right, #8b5cf6, #a855f7);
            position: relative;
            border-radius: 1px;
        }
        .fret {
            border-right: 2px solid #666;
            height: 100%;
        }
        .position-marker {
            position: absolute;
            width: 1px;
            height: 100%;
            background: #999;
            opacity: 0.3;
        }
        
        /* ÌÖåÎßà Í¥ÄÎ†® CSS */
        .light-theme {
            background: white;
            color: black;
        }
        .dark-theme {
            background: #1a1a1a;
            color: white;
        }
        .light-theme .panel-bg {
            background: #f8f9fa;
            border-color: #e9ecef;
        }
        .dark-theme .panel-bg {
            background: #2d3748;
            border-color: #4a5568;
        }
        .light-theme .input-bg {
            background: white;
            color: black;
            border-color: #d1d5db;
        }
        .dark-theme .input-bg {
            background: #374151;
            color: white;
            border-color: #6b7280;
        }
        .light-theme .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .light-theme .btn-primary:hover {
            background: #2563eb;
        }
        .dark-theme .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .dark-theme .btn-primary:hover {
            background: #2563eb;
        }
        .light-theme .btn-secondary {
            background: #ef4444;
            color: white;
        }
        .light-theme .btn-secondary:hover {
            background: #dc2626;
        }
        .dark-theme .btn-secondary {
            background: #ef4444;
            color: white;
        }
        .dark-theme .btn-secondary:hover {
            background: #dc2626;
        }
        
        /* Ïû¨ÏÉù ÏòµÏÖò Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .subdivision-btn {
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .subdivision-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .subdivision-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }
        .dark-theme .subdivision-btn {
            border-color: #6b7280;
        }
        .dark-theme .subdivision-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }
        
        /* ÏùåÌëú ÏïÑÏù¥ÏΩò Ïä§ÌÉÄÏùº */
        .note-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }
        
        /* ÏΩîÎìú Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
        .chord-item {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            min-width: 120px;
            flex-shrink: 0;
        }
        .dark-theme .chord-item {
            border-color: #6b7280;
            background: rgba(55, 65, 81, 0.8);
        }
        .chord-item:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .chord-item.playing {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            animation: pulse-glow 2s infinite;
        }
        .dark-theme .chord-item.playing {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.15));
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 8px 35px rgba(16, 185, 129, 0.5); }
        }
        .chord-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            display: none;
            gap: 4px;
        }
        .chord-item:hover .chord-controls {
            display: flex;
        }
        .chord-duration-controls {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 4px;
        }
        .chord-item:hover .chord-duration-controls {
            display: flex;
        }
        .control-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .control-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: scale(1.1);
        }
        .control-btn.delete {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        .control-btn.delete:hover {
            background: #dc2626;
        }
        .chord-duration-display {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
            margin-top: 6px;
            font-weight: 500;
        }
        .chord-name-display {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 4px;
            color: #1f2937;
        }
        .dark-theme .chord-name-display {
            color: #f9fafb;
        }
        .chord-item.playing .chord-name-display {
            color: #10b981;
        }
    </style>
</head>
<body class="light-theme min-h-screen p-4 transition-colors duration-300" id="body">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold" id="mainTitle">üé∏ Í∏∞ÌÉÄ Ïä§ÏºÄÏùº Ïó∞Ïäµ ÎèÑÍµ¨</h1>
            <div class="flex items-center gap-4">
                <!-- ÏïÖÍ∏∞ ÏÑ†ÌÉù -->
                <div class="flex items-center gap-2">
                    <select id="instrumentSelect" class="input-bg rounded px-3 py-1 border text-sm">
                        <option value="guitar">üé∏ Í∏∞ÌÉÄ</option>
                        <option value="bass4">üé∏ 4ÌòÑ Î≤†Ïù¥Ïä§</option>
                        <option value="bass5">üé∏ 5ÌòÑ Î≤†Ïù¥Ïä§</option>
                        <option value="violin">üéª Î∞îÏù¥Ïò¨Î¶∞</option>
                    </select>
                </div>
                <!-- ÏßÄÌåê Î™®Îìú ÌÜ†Í∏Ä (Í∏∞ÌÉÄÏùº ÎïåÎßå) -->
                <div class="flex items-center gap-2" id="fretboardModeDiv">
                    <label class="relative inline-flex items-center cursor-pointer" title="ÏÉÅÌïòÎ∞òÏ†Ñ">
                        <input type="checkbox" id="fretboardMode" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="text-sm">‚áÖ</span>
                </div>
                <!-- Î∞îÏù¥Ïò¨Î¶∞ Î™®Îìú ÌÜ†Í∏Ä (Î∞îÏù¥Ïò¨Î¶∞Ïùº ÎïåÎßå) -->
                <div class="flex items-center gap-2" id="violinModeDiv" style="display: none;">
                    <label class="relative inline-flex items-center cursor-pointer" title="ÏÉÅÌïòÎ∞òÏ†Ñ">
                        <input type="checkbox" id="violinMode" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="text-sm">‚áÖ</span>
                </div>
                <!-- Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä -->
                <div class="flex items-center gap-2">
                    <span class="text-sm">üåû</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="darkMode" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                    <span class="text-sm">üåô</span>
                </div>
            </div>
        </div>
        
        <!-- ÏÑ§Ï†ï Ìå®ÎÑê -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <!-- Ïä§ÏºÄÏùº ÏÑ§Ï†ï -->
            <div class="panel-bg rounded-lg p-3 border">
                <h3 class="text-base font-semibold mb-2">üéµ Ïä§ÏºÄÏùº ÏÑ§Ï†ï</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs mb-1">ÌÇ§ ÏÑºÌÑ∞</label>
                        <select id="keyCenter" class="w-full input-bg rounded px-2 py-1 border text-sm">
                            <option value="C">C</option>
                            <option value="C#">C#</option>
                            <option value="D">D</option>
                            <option value="D#">D#</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">F#</option>
                            <option value="G">G</option>
                            <option value="G#">G#</option>
                            <option value="A">A</option>
                            <option value="A#">A#</option>
                            <option value="B">B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs mb-1">Ïä§ÏºÄÏùº</label>
                        <select id="scaleType" class="w-full input-bg rounded px-2 py-1 border text-sm">
                            <option value="major">Î©îÏù¥Ï†Ä</option>
                            <option value="dorian">ÎèÑÎ¶¨Ïïà</option>
                            <option value="phrygian">ÌîÑÎ¶¨ÏßÄÏïà</option>
                            <option value="lydian">Î¶¨ÎîîÏïà</option>
                            <option value="mixolydian">ÎØπÏÜîÎ¶¨ÎîîÏñ∏</option>
                            <option value="minor">ÎßàÏù¥ÎÑà</option>
                            <option value="locrian">Î°úÌÅ¨Î¶¨Ïïà</option>
                            <option value="majorPentatonic">Î©îÏù¥Ï†Ä ÌéúÌÉÄ</option>
                            <option value="minorPentatonic">ÎßàÏù¥ÎÑà ÌéúÌÉÄ</option>
                            <option value="wholeTone">ÌôÄÌÜ§</option>
                            <option value="harmonicMinor">ÌïòÎ™®Îãâ ÎßàÏù¥ÎÑà</option>
                            <option value="bebop">ÎπÑÎ∞•</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï -->
            <div class="panel-bg rounded-lg p-3 border">
                <h3 class="text-base font-semibold mb-2">‚è±Ô∏è Ïó∞Ïäµ ÌÉÄÏù¥Î®∏</h3>
                <div class="grid grid-cols-3 gap-2 items-end">
                    <div>
                        <label class="block text-xs mb-1">ÌÉÄÏûÖ</label>
                        <select id="timerType" class="w-full input-bg rounded px-2 py-1 border text-sm">
                            <option value="time">ÏãúÍ∞Ñ</option>
                            <option value="bars">ÏÜåÏ†à</option>
                        </select>
                    </div>
                    <div id="timeTimerDiv">
                        <label class="block text-xs mb-1">ÏãúÍ∞Ñ</label>
                        <select id="timeTimer" class="w-full input-bg rounded px-2 py-1 border text-sm">
                            <option value="5">5Î∂Ñ</option>
                            <option value="10">10Î∂Ñ</option>
                            <option value="15">15Î∂Ñ</option>
                            <option value="20">20Î∂Ñ</option>
                        </select>
                    </div>
                    <div id="barsTimerDiv" style="display: none;">
                        <label class="block text-xs mb-1">ÏÜåÏ†à</label>
                        <input type="number" id="barsTimer" value="32" min="1" max="999" class="w-full input-bg rounded px-2 py-1 border text-sm">
                    </div>
                    <div class="text-center">
                        <div id="timerDisplay" class="text-lg font-bold mb-1">5:00</div>
                        <button id="timerStart" class="btn-primary rounded px-2 py-1 text-xs">ÏãúÏûë</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Î©îÌä∏Î°úÎÜà & Î∞ïÏûê ÌëúÏãúÍ∏∞ -->
        <div class="panel-bg rounded-lg p-3 mb-4 border">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-semibold">ü•Å Î©îÌä∏Î°úÎÜà</h3>
                <div class="flex items-center gap-4">
                    <!-- ÏΩîÎìúÏßÑÌñâ Î™®Îìú ÌÜ†Í∏Ä -->
                    <div class="flex items-center gap-2">
                        <span class="text-xs">Î©îÌä∏Î°úÎÜà</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="chordMode" class="sr-only peer">
                            <div class="w-8 h-4 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[1px] after:left-[1px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                        <span class="text-xs">ÏΩîÎìúÏßÑÌñâ</span>
                    </div>
                    <!-- ÏùåÎüâ Ï°∞Ï†à Î≤ÑÌäº -->
                    <div class="relative">
                        <button id="volumeToggle" class="btn-primary rounded px-2 py-1 text-xs">üîä</button>
                        <div id="volumePanel" class="absolute top-full right-0 mt-1 panel-bg rounded-lg p-3 border shadow-lg z-50 min-w-[300px]" style="display: none;">
                            <h3 class="text-sm font-semibold mb-2">üîä ÏùåÎüâ Ï°∞Ï†à</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs mb-1">Î©îÌä∏Î°úÎÜà</label>
                                    <input type="range" id="metronomeVolume" min="0" max="100" value="50" class="w-full">
                                    <div class="text-xs text-center mt-1"><span id="metronomeVolumeDisplay">50</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-xs mb-1">Î≤†Ïù¥Ïä§</label>
                                    <input type="range" id="bassVolume" min="0" max="100" value="50" class="w-full">
                                    <div class="text-xs text-center mt-1"><span id="bassVolumeDisplay">50</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-xs mb-1">ÌîºÏïÑÎÖ∏</label>
                                    <input type="range" id="pianoVolume" min="0" max="100" value="50" class="w-full">
                                    <div class="text-xs text-center mt-1"><span id="pianoVolumeDisplay">50</span>%</div>
                                </div>
                                <div>
                                    <label class="block text-xs mb-1">ÏïÖÍ∏∞Ïùå</label>
                                    <input type="range" id="instrumentVolume" min="0" max="100" value="70" class="w-full">
                                    <div class="text-xs text-center mt-1"><span id="instrumentVolumeDisplay">70</span>%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-12 gap-2 items-center">
                <!-- Î©îÌä∏Î°úÎÜà ÏÑ§Ï†ï -->
                <div class="col-span-2">
                    <label class="block text-xs mb-1">BPM</label>
                    <input type="number" id="bpm" value="120" min="60" max="200" class="w-full input-bg rounded px-2 py-1 border text-sm">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs mb-1">Î∞ïÏûêÌëú</label>
                    <select id="timeSignature" class="w-full input-bg rounded px-2 py-1 border text-sm">
                        <option value="2/2">2/2</option>
                        <option value="3/4">3/4</option>
                        <option value="4/4" selected>4/4</option>
                        <option value="6/8">6/8</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-xs mb-1">ÏÇ¨Ïö¥Îìú</label>
                    <select id="metronomeSound" class="w-full input-bg rounded px-2 py-1 border text-sm">
                        <option value="beep">ÎπÑÌîÑ</option>
                        <option value="drum">ÎìúÎüº</option>
                    </select>
                </div>
                
                <!-- Ïû¨ÏÉù ÏòµÏÖò -->
                <div class="col-span-2">
                    <label class="block text-xs mb-1">Ïû¨ÏÉù ÏòµÏÖò</label>
                    <div class="grid grid-cols-6 gap-1">
                        <button class="subdivision-btn active text-xs" data-value="quarter" title="4Î∂ÑÏùåÌëú">‚ô©</button>
                        <button class="subdivision-btn text-xs" data-value="eighth" title="8Î∂ÑÏùåÌëú">‚ô´</button>
                        <button class="subdivision-btn text-xs" data-value="triplet" title="ÏÖãÏûáÎã®ÏùåÌëú">‚ô™‚ô™‚ô™</button>
                        <button class="subdivision-btn text-xs" data-value="tripletGhost" title="ÏÖãÏûáÎã®ÏùåÌëú(Í∞ÄÏö¥Îç∞Îπà)">‚ô™_‚ô™</button>
                        <button class="subdivision-btn text-xs" data-value="sixteenth" title="16Î∂ÑÏùåÌëú">‚ô¨</button>
                        <button class="subdivision-btn text-xs" data-value="sixteenthSparse" title="16Î∂ÑÏùåÌëú(1,4Îßå)">‚ô¨_‚ô¨</button>
                    </div>
                </div>
                
                <!-- Î∞ïÏûê ÌëúÏãúÍ∏∞ -->
                <div class="col-span-2">
                    <label class="block text-xs mb-1">Î∞ïÏûê ÌëúÏãú</label>
                    <div id="beatIndicators" class="flex gap-1"></div>
                </div>
                
                <!-- Ïª®Ìä∏Î°§ Î≤ÑÌäº -->
                <div class="col-span-1">
                    <div class="flex flex-col gap-1">
                        <button id="metronomePlay" class="btn-primary rounded px-2 py-1 text-xs">Ïû¨ÏÉù</button>
                        <button id="metronomeStop" class="btn-secondary rounded px-2 py-1 text-xs">Ï†ïÏßÄ</button>
                    </div>
                </div>
            </div>
            
            <!-- ÏΩîÎìúÏßÑÌñâ ÏÑ§Ï†ï -->
            <div id="chordSettings" style="display: none;" class="mt-3 pt-2 border-t">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-medium">ÌòÑÏû¨ Ïó∞Ï£º: <span id="currentChordDisplay">-</span></span>
                    <button id="addChord" class="text-blue-500 hover:text-blue-700 text-xs">+ ÏΩîÎìú Ï∂îÍ∞Ä</button>
                </div>
            </div>
        </div>

        <!-- ÏΩîÎìú ÏßÑÌñâ ÌëúÏãú -->
        <div id="chordProgressionDisplay" class="panel-bg rounded-lg p-3 mb-4 border" style="display: none;">
            <div class="overflow-x-auto">
                <div id="chordContainer" class="flex gap-2 min-w-max">
                    <!-- ÏΩîÎìúÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- ÏïÖÍ∏∞ ÏßÄÌåê -->
        <div class="panel-bg rounded-lg p-3 border">
            <h3 class="text-base font-semibold mb-2 text-center" id="fretboardTitle">Í∏∞ÌÉÄ ÌîÑÎ†õÎ≥¥Îìú</h3>
            <div class="overflow-x-auto px-4">
                <div id="fretboard" class="relative min-w-[1100px] mx-auto"></div>
            </div>
        </div>


    </div>

    <script>
        // ÏùåÍ≥Ñ Ï†ïÏùò
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // ÏïÖÍ∏∞Î≥Ñ ÌäúÎãù Ï†ïÏùò (Ïò•ÌÉÄÎ∏å Ìè¨Ìï®)
        const guitarTuning = [
            {note: 'E', octave: 2}, // 6ÌòÑ (Í∞ÄÏû• ÎÇÆÏùÄ ÌòÑ)
            {note: 'A', octave: 2}, // 5ÌòÑ
            {note: 'D', octave: 3}, // 4ÌòÑ
            {note: 'G', octave: 3}, // 3ÌòÑ
            {note: 'B', octave: 3}, // 2ÌòÑ
            {note: 'E', octave: 4}  // 1ÌòÑ (Í∞ÄÏû• ÎÜíÏùÄ ÌòÑ)
        ];
        
        const bass4Tuning = [
            {note: 'E', octave: 1}, // 4ÌòÑ (Í∞ÄÏû• ÎÇÆÏùÄ ÌòÑ)
            {note: 'A', octave: 1}, // 3ÌòÑ
            {note: 'D', octave: 2}, // 2ÌòÑ
            {note: 'G', octave: 2}  // 1ÌòÑ (Í∞ÄÏû• ÎÜíÏùÄ ÌòÑ)
        ];
        
        const bass5Tuning = [
            {note: 'B', octave: 0}, // 5ÌòÑ (Í∞ÄÏû• ÎÇÆÏùÄ ÌòÑ)
            {note: 'E', octave: 1}, // 4ÌòÑ
            {note: 'A', octave: 1}, // 3ÌòÑ
            {note: 'D', octave: 2}, // 2ÌòÑ
            {note: 'G', octave: 2}  // 1ÌòÑ (Í∞ÄÏû• ÎÜíÏùÄ ÌòÑ)
        ];
        
        const violinTuning = [
            {note: 'G', octave: 3}, // 4ÌòÑ (Í∞ÄÏû• ÎÇÆÏùÄ ÌòÑ)
            {note: 'D', octave: 4}, // 3ÌòÑ
            {note: 'A', octave: 4}, // 2ÌòÑ
            {note: 'E', octave: 5}  // 1ÌòÑ (Í∞ÄÏû• ÎÜíÏùÄ ÌòÑ)
        ];
        
        let currentInstrument = 'guitar'; // 'guitar', 'bass4', 'bass5', ÎòêÎäî 'violin'
        let stringTuning = guitarTuning;

        // Ïä§ÏºÄÏùº Ìå®ÌÑ¥ Ï†ïÏùò (Î∞òÏùå Í∞ÑÍ≤©)
        const scalePatterns = {
            major: [0, 2, 4, 5, 7, 9, 11],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            minor: [0, 2, 3, 5, 7, 8, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            majorPentatonic: [0, 2, 4, 7, 9],
            minorPentatonic: [0, 3, 5, 7, 10],
            minorMajorPentatonic: [0, 3, 4, 7, 10],
            wholeTone: [0, 2, 4, 6, 8, 10],
            mixolydianbF9bF13: [0, 1, 4, 5, 7, 8, 10],
            naturalMinor: [0, 2, 3, 5, 7, 8, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            bebop: [0, 2, 4, 5, 7, 9, 10, 11]
        };

        // Ïä§ÏºÄÏùº ÎèÑÏàò ÌëúÍ∏∞
        const scaleIntervals = {
            major: ['R', '2', '3', '4', '5', '6', '7'],
            dorian: ['R', '2', 'b3', '4', '5', '6', 'b7'],
            phrygian: ['R', 'b2', 'b3', '4', '5', 'b6', 'b7'],
            lydian: ['R', '2', '3', '#4', '5', '6', '7'],
            mixolydian: ['R', '2', '3', '4', '5', '6', 'b7'],
            minor: ['R', '2', 'b3', '4', '5', 'b6', 'b7'],
            locrian: ['R', 'b2', 'b3', '4', 'b5', 'b6', 'b7'],
            majorPentatonic: ['R', '2', '3', '5', '6'],
            minorPentatonic: ['R', 'b3', '4', '5', 'b7'],
            minorMajorPentatonic: ['R', 'b3', '3', '5', 'b7'],
            wholeTone: ['R', '2', '3', '#4', '#5', '#6'],
            mixolydianbF9bF13: ['R', 'b2', '3', '4', '5', 'b6', 'b7'],
            naturalMinor: ['R', '2', 'b3', '4', '5', 'b6', 'b7'],
            harmonicMinor: ['R', '2', 'b3', '4', '5', 'b6', '7'],
            bebop: ['R', '2', '3', '4', '5', '6', 'b7', '7']
        };

        // ÏÉâÏÉÅ Ï†ïÏùò
        const intervalColors = {
            'R': '#ef4444',     // Îπ®Í∞ï (Î£®Ìä∏)
            '2': '#f97316',     // Ï£ºÌô©
            'b2': '#f59e0b',    // ÎÖ∏Îûë-Ï£ºÌô©
            '3': '#eab308',     // ÎÖ∏Îûë
            'b3': '#84cc16',    // Ïó∞Îëê
            '4': '#22c55e',     // Ï¥àÎ°ù
            '#4': '#10b981',    // Ï≤≠Î°ù
            '5': '#06b6d4',     // ÌïòÎäò
            'b5': '#0ea5e9',    // ÌååÎûë
            '6': '#3b82f6',     // ÏßÑÌååÎûë
            'b6': '#6366f1',    // ÎÇ®Î≥¥Îùº
            '7': '#8b5cf6',     // Î≥¥Îùº
            'b7': '#a855f7',    // ÏßÑÎ≥¥Îùº
            '#5': '#d946ef',    // ÏûêÏ£º
            '#6': '#ec4899'     // Î∂ÑÌôç
        };

        let metronomeInterval = null;
        let chordInterval = null;
        let timerInterval = null;
        let currentBeat = 0;
        let beatCount = 4;
        let beatStates = [true, true, true, true];
        let audioContext = null;
        let timerSeconds = 0;
        let timerBars = 0;
        let currentChordBar = 0;
        let currentSubdivision = 'quarter';
        
        // ÏΩîÎìú ÏßÑÌñâ ÏãúÏä§ÌÖú
        let chordProgression = [
            { root: 'C', quality: 'major', seventh: '', tensions: [], duration: 4 },
            { root: 'A', quality: 'minor', seventh: '', tensions: [], duration: 4 },
            { root: 'F', quality: 'major', seventh: '', tensions: [], duration: 4 },
            { root: 'G', quality: 'major', seventh: '', tensions: [], duration: 4 }
        ];
        let currentChordIndex = 0;
        let currentChordBeat = 0;

        // ÏùåÌëú ÏïÑÏù¥ÏΩò Ï†ïÏùò (Ìñ•ÌõÑ Î≤°ÌÑ∞ Ïù¥ÎØ∏ÏßÄÎ°ú ÍµêÏ≤¥ Í∞ÄÎä•)
        const noteIcons = {
            quarter: '‚ô©',
            eighth: '‚ô´',
            triplet: '‚ô™‚ô™‚ô™',
            tripletGhost: '‚ô™_‚ô™',
            sixteenth: '‚ô¨',
            sixteenthSparse: '‚ô¨_‚ô¨'
        };

        // ÏùåÌëú ÏïÑÏù¥ÏΩò ÏÉùÏÑ± Ìï®Ïàò
        function createNoteIcon(noteType) {
            // Ìñ•ÌõÑ Î≤°ÌÑ∞ Ïù¥ÎØ∏ÏßÄ ÏßÄÏõêÏùÑ ÏúÑÌïú Íµ¨Ï°∞
            const iconContainer = document.createElement('div');
            iconContainer.className = 'note-icon-container';
            
            // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏ (Ìñ•ÌõÑ Íµ¨ÌòÑ)
            const imagePath = `/images/notes/${noteType}.svg`;
            
            // ÌòÑÏû¨Îäî ÌÖçÏä§Ìä∏ ÏïÑÏù¥ÏΩò ÏÇ¨Ïö©, Ìñ•ÌõÑ Ïù¥ÎØ∏ÏßÄÎ°ú ÍµêÏ≤¥ Í∞ÄÎä•
            iconContainer.innerHTML = noteIcons[noteType] || '‚ô©';
            
            // Ìñ•ÌõÑ Ïù¥ÎØ∏ÏßÄ ÏßÄÏõê ÏΩîÎìú (Ï£ºÏÑù Ï≤òÎ¶¨)
            /*
            const img = new Image();
            img.onload = () => {
                iconContainer.innerHTML = `<img src="${imagePath}" alt="${noteType}" style="width: 100%; height: 100%;">`;
            };
            img.onerror = () => {
                iconContainer.innerHTML = noteIcons[noteType] || '‚ô©';
            };
            img.src = imagePath;
            */
            
            return iconContainer;
        }

        // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // ÎπÑÌîÑ ÏÜåÎ¶¨ ÏÉùÏÑ±
        function playBeep(frequency = 800, duration = 100) {
            if (!audioContext) return;
            
            const metronomeVol = document.getElementById('metronomeVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3 * metronomeVol, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // ÎìúÎüº ÏÇ¨Ïö¥Îìú ÏÉùÏÑ±
        function playDrum(drumType = 'kick', duration = 100) {
            if (!audioContext) return;
            
            const metronomeVol = document.getElementById('metronomeVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const filterNode = audioContext.createBiquadFilter();
            
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch (drumType) {
                case 'kick':
                    oscillator.frequency.value = 60;
                    oscillator.type = 'sine';
                    filterNode.type = 'lowpass';
                    filterNode.frequency.value = 100;
                    gainNode.gain.setValueAtTime(0.8 * metronomeVol, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                    break;
                case 'snare':
                    oscillator.frequency.value = 200;
                    oscillator.type = 'square';
                    filterNode.type = 'highpass';
                    filterNode.frequency.value = 1000;
                    gainNode.gain.setValueAtTime(0.5 * metronomeVol, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                    break;
                case 'hihat':
                    oscillator.frequency.value = 8000;
                    oscillator.type = 'square';
                    filterNode.type = 'highpass';
                    filterNode.frequency.value = 5000;
                    gainNode.gain.setValueAtTime(0.3 * metronomeVol, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000 * 0.3);
                    break;
            }
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // Î≤†Ïù¥Ïä§ ÏÜåÎ¶¨ ÏÉùÏÑ±
        function playBass(frequency = 82, duration = 500) {
            if (!audioContext) return;
            
            const bassVol = document.getElementById('bassVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.2 * bassVol, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // Ïã§Ï†ú Ïùå Ï£ºÌååÏàò Í≥ÑÏÇ∞ (C4 = 261.63Hz Í∏∞Ï§Ä)
        function getNoteFrequency(note, octave) {
            const noteFrequencies = {
                'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
                'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
            };
            
            const semitoneFromC4 = (octave - 4) * 12 + noteFrequencies[note];
            return 261.63 * Math.pow(2, semitoneFromC4 / 12);
        }

        // ÌôïÏû• Í∞ÄÎä•Ìïú ÏïÖÍ∏∞ ÏÜåÎ¶¨ Ïû¨ÏÉù ÏãúÏä§ÌÖú
        async function playInstrumentNote(note, octave, instrument = currentInstrument, duration = 500) {
            const noteKey = `${note}${octave}`;
            
            // 1Îã®Í≥Ñ: Ïã§Ï†ú ÏïÖÍ∏∞ ÏÉòÌîå ÌååÏùº ÌôïÏù∏ (Ìñ•ÌõÑ Íµ¨ÌòÑ)
            const samplePath = `/sounds/${instrument}/${noteKey}.mp3`;
            
            try {
                // Ìñ•ÌõÑ Ïã§Ï†ú ÏïÖÍ∏∞ ÏÉòÌîå Ïû¨ÏÉù ÏΩîÎìú
                /*
                const audio = new Audio(samplePath);
                audio.volume = 0.7;
                await audio.play();
                return;
                */
            } catch (error) {
                // ÏÉòÌîå ÌååÏùºÏù¥ ÏóÜÏúºÎ©¥ Ï£ºÌååÏàòÎ°ú Ïû¨ÏÉù
            }
            
            // 2Îã®Í≥Ñ: Ï£ºÌååÏàòÎ°ú Ïû¨ÏÉù (ÌòÑÏû¨ Íµ¨ÌòÑ)
            const frequency = getNoteFrequency(note, octave);
            
            // ÏïÖÍ∏∞Î≥Ñ ÏùåÏÉâ ÏÑ§Ï†ï
            let waveType = 'sine';
            let volume = 0.3;
            const instrumentVol = document.getElementById('instrumentVolume').value / 100;
            
            switch (instrument) {
                case 'guitar':
                    waveType = 'sawtooth';
                    volume = 0.4 * instrumentVol;
                    break;
                case 'bass4':
                case 'bass5':
                    waveType = 'sawtooth';
                    volume = 0.5 * instrumentVol;
                    break;
                case 'violin':
                    waveType = 'triangle';
                    volume = 0.3 * instrumentVol;
                    break;
            }
            
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = waveType;
            
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // ÏïÖÍ∏∞ Î≥ÄÍ≤Ω Ìï®Ïàò
        function switchInstrument() {
            const selectedInstrument = document.getElementById('instrumentSelect').value;
            const mainTitle = document.getElementById('mainTitle');
            const fretboardTitle = document.getElementById('fretboardTitle');
            const fretboardModeDiv = document.getElementById('fretboardModeDiv');
            const violinModeDiv = document.getElementById('violinModeDiv');
            
            currentInstrument = selectedInstrument;
            
            switch (selectedInstrument) {
                case 'guitar':
                    stringTuning = guitarTuning;
                    mainTitle.textContent = 'üé∏ Í∏∞ÌÉÄ Ïä§ÏºÄÏùº Ïó∞Ïäµ ÎèÑÍµ¨';
                    fretboardTitle.textContent = 'Í∏∞ÌÉÄ ÌîÑÎ†õÎ≥¥Îìú';
                    fretboardModeDiv.style.display = 'flex';
                    violinModeDiv.style.display = 'none';
                    break;
                case 'bass4':
                    stringTuning = bass4Tuning;
                    mainTitle.textContent = 'üé∏ 4ÌòÑ Î≤†Ïù¥Ïä§ Ïä§ÏºÄÏùº Ïó∞Ïäµ ÎèÑÍµ¨';
                    fretboardTitle.textContent = '4ÌòÑ Î≤†Ïù¥Ïä§ ÌîÑÎ†õÎ≥¥Îìú';
                    fretboardModeDiv.style.display = 'flex';
                    violinModeDiv.style.display = 'none';
                    break;
                case 'bass5':
                    stringTuning = bass5Tuning;
                    mainTitle.textContent = 'üé∏ 5ÌòÑ Î≤†Ïù¥Ïä§ Ïä§ÏºÄÏùº Ïó∞Ïäµ ÎèÑÍµ¨';
                    fretboardTitle.textContent = '5ÌòÑ Î≤†Ïù¥Ïä§ ÌîÑÎ†õÎ≥¥Îìú';
                    fretboardModeDiv.style.display = 'flex';
                    violinModeDiv.style.display = 'none';
                    break;
                case 'violin':
                    stringTuning = violinTuning;
                    mainTitle.textContent = 'üéª Î∞îÏù¥Ïò¨Î¶∞ Ïä§ÏºÄÏùº Ïó∞Ïäµ ÎèÑÍµ¨';
                    fretboardTitle.textContent = 'Î∞îÏù¥Ïò¨Î¶∞ ÏßÄÌåê';
                    fretboardModeDiv.style.display = 'none';
                    violinModeDiv.style.display = 'flex';
                    break;
            }
            
            createFretboard();
        }

        // ÌîÑÎ†õÎ≥¥Îìú/ÏßÄÌåê ÏÉùÏÑ±
        function createFretboard() {
            const fretboard = document.getElementById('fretboard');
            fretboard.innerHTML = '';
            
            const fretboardWidth = 1100;
            const stringCount = stringTuning.length;
            const fretboardHeight = stringCount === 4 ? 120 : 200; // 4ÌòÑ ÏïÖÍ∏∞Îäî Îçî ÏûëÍ≤å
            const fretWidth = fretboardWidth / 23; // 0ÌîÑÎ†õ + 22ÌîÑÎ†õ
            const stringSpacing = 25; // ÌòÑ Í∞ÑÍ≤©
            
            fretboard.style.width = fretboardWidth + 'px';
            fretboard.style.height = fretboardHeight + 'px';
            
            // ÌòÑ Í∑∏Î¶¨Í∏∞
            for (let string = 0; string < stringCount; string++) {
                const stringEl = document.createElement('div');
                stringEl.className = currentInstrument === 'violin' ? 'violin-string' : 'string';
                stringEl.style.position = 'absolute';
                stringEl.style.top = (30 + string * stringSpacing) + 'px';
                stringEl.style.left = '0px';
                stringEl.style.width = '100%';
                fretboard.appendChild(stringEl);
            }
            
            if (currentInstrument === 'guitar' || currentInstrument === 'bass4' || currentInstrument === 'bass5') {
                // Í∏∞ÌÉÄ/Î≤†Ïù¥Ïä§ ÌîÑÎ†õ Í∑∏Î¶¨Í∏∞
                const fretHeight = stringCount <= 5 ? (stringCount === 4 ? 100 : 125) : 160; // Î≤†Ïù¥Ïä§Îäî Îçî ÏûëÍ≤å
                const markerTop = stringCount <= 5 ? (stringCount === 4 ? 140 : 165) : 190;
                
                for (let fret = 1; fret <= 22; fret++) {
                    const fretEl = document.createElement('div');
                    fretEl.className = 'fret';
                    fretEl.style.position = 'absolute';
                    fretEl.style.left = (fret * fretWidth) + 'px';
                    fretEl.style.top = '20px';
                    fretEl.style.height = fretHeight + 'px';
                    fretboard.appendChild(fretEl);
                    
                    // ÌîÑÎ†õ ÎßàÏª§ (Ïù∏Î†àÏù¥)
                    if ([3, 5, 7, 9, 15, 17, 19].includes(fret)) {
                        const marker = document.createElement('div');
                        marker.className = 'fret-marker';
                        marker.style.left = (fret * fretWidth - fretWidth/2 - 4) + 'px';
                        marker.style.top = markerTop + 'px';
                        fretboard.appendChild(marker);
                    } else if (fret === 12) {
                        // 12ÌîÑÎ†õÏùÄ Îëê Í∞úÏùò ÎßàÏª§
                        const marker1 = document.createElement('div');
                        marker1.className = 'fret-marker double';
                        marker1.style.left = (fret * fretWidth - fretWidth/2 - 8) + 'px';
                        marker1.style.top = markerTop + 'px';
                        fretboard.appendChild(marker1);
                        
                        const marker2 = document.createElement('div');
                        marker2.className = 'fret-marker double';
                        marker2.style.left = (fret * fretWidth - fretWidth/2 + 2) + 'px';
                        marker2.style.top = markerTop + 'px';
                        fretboard.appendChild(marker2);
                    }
                }
            } else {
                // Î∞îÏù¥Ïò¨Î¶∞ Ìè¨ÏßÄÏÖò ÎßàÏª§ (ÌîÑÎ†õ ÎåÄÏã† ÏúÑÏπò Í∞ÄÏù¥Îìú)
                const positions = [3, 5, 7, 9, 12, 15, 17, 19]; // Ï£ºÏöî Ìè¨ÏßÄÏÖòÎì§
                positions.forEach(pos => {
                    const marker = document.createElement('div');
                    marker.className = 'position-marker';
                    marker.style.left = (pos * fretWidth) + 'px';
                    marker.style.top = '20px';
                    marker.style.height = (stringCount * stringSpacing + 20) + 'px';
                    fretboard.appendChild(marker);
                });
            }
            
            updateScale();
        }

        // ÏùåÌëú Ïù∏Îç±Ïä§ Í≥ÑÏÇ∞
        function getNoteIndex(note) {
            return notes.indexOf(note);
        }

        // ÌîÑÎ†õ/Ìè¨ÏßÄÏÖòÏùò ÏùåÌëúÏôÄ Ïò•ÌÉÄÎ∏å Í≥ÑÏÇ∞
        function getFretNote(stringIndex, fret) {
            const openString = stringTuning[stringIndex];
            const openNote = openString.note;
            const openOctave = openString.octave;
            const openNoteIndex = getNoteIndex(openNote);
            
            const totalSemitones = openNoteIndex + fret;
            const noteIndex = totalSemitones % 12;
            const octaveOffset = Math.floor(totalSemitones / 12);
            
            return {
                note: notes[noteIndex],
                octave: openOctave + octaveOffset
            };
        }

        // Ïä§ÏºÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
        function updateScale() {
            const keyCenter = document.getElementById('keyCenter').value;
            const scaleType = document.getElementById('scaleType').value;
            const fretboard = document.getElementById('fretboard');
            
            // ÌòÑÏû¨ ÏïÖÍ∏∞Ïóê Îî∞Î•∏ Î™®Îìú ÌôïÏù∏
            let isRealMode;
            if (currentInstrument === 'guitar' || currentInstrument === 'bass4' || currentInstrument === 'bass5') {
                isRealMode = document.getElementById('fretboardMode').checked;
            } else {
                isRealMode = document.getElementById('violinMode').checked;
            }
            
            // Í∏∞Ï°¥ Ïä§ÏºÄÏùº ÎÖ∏Ìä∏ Ï†úÍ±∞
            const existingNotes = fretboard.querySelectorAll('.scale-note');
            existingNotes.forEach(note => note.remove());
            
            const pattern = scalePatterns[scaleType];
            const intervals = scaleIntervals[scaleType];
            const keyCenterIndex = getNoteIndex(keyCenter);
            const fretWidth = 1100 / 23;
            const stringCount = stringTuning.length;
            const stringSpacing = 25;
            
            // Ïä§ÏºÄÏùº ÎÖ∏Ìä∏Îì§ Í≥ÑÏÇ∞
            const scaleNotes = pattern.map(interval => notes[(keyCenterIndex + interval) % 12]);
            
            // Í∞Å ÌòÑÍ≥º ÌîÑÎ†õ/Ìè¨ÏßÄÏÖòÏóê ÎåÄÌï¥ Ïä§ÏºÄÏùº ÎÖ∏Ìä∏ ÌëúÏãú
            for (let string = 0; string < stringCount; string++) {
                for (let fret = 0; fret <= 22; fret++) {
                    let displayString;
                    if (currentInstrument === 'guitar' || currentInstrument === 'bass4' || currentInstrument === 'bass5') {
                        displayString = isRealMode ? string : (stringCount - 1 - string);
                    } else {
                        // Î∞îÏù¥Ïò¨Î¶∞: Ïã§Î¨ºÎ™®ÎìúÍ∞Ä Í∏∞Î≥∏Í∞íÏù¥ÎØÄÎ°ú Î∞òÎåÄÎ°ú Ï≤òÎ¶¨
                        displayString = isRealMode ? (stringCount - 1 - string) : string;
                    }
                    
                    const fretNoteData = getFretNote(string, fret);
                    const scaleIndex = scaleNotes.indexOf(fretNoteData.note);
                    
                    if (scaleIndex !== -1) {
                        const noteEl = document.createElement('div');
                        noteEl.className = 'scale-note';
                        noteEl.textContent = intervals[scaleIndex];
                        noteEl.style.position = 'absolute';
                        noteEl.style.left = (fret === 0 ? -25 : (fret - 0.5) * fretWidth - 12) + 'px';
                        noteEl.style.top = (18 + displayString * stringSpacing) + 'px';
                        noteEl.style.backgroundColor = intervalColors[intervals[scaleIndex]];
                        noteEl.style.zIndex = '10';
                        
                        noteEl.addEventListener('click', () => {
                            // Ïã§Ï†ú Ïùå Ï£ºÌååÏàòÎ°ú Ïû¨ÏÉù
                            playInstrumentNote(fretNoteData.note, fretNoteData.octave, currentInstrument, 400);
                        });
                        
                        fretboard.appendChild(noteEl);
                    }
                }
            }
        }

        // Î∞ïÏûê ÌëúÏãúÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateBeatIndicators() {
            const timeSignature = document.getElementById('timeSignature').value;
            const [numerator] = timeSignature.split('/').map(Number);
            beatCount = numerator;
            
            const container = document.getElementById('beatIndicators');
            container.innerHTML = '';
            
            beatStates = new Array(beatCount).fill(true);
            
            for (let i = 0; i < beatCount; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'beat-indicator';
                indicator.textContent = i + 1;
                indicator.addEventListener('click', () => {
                    beatStates[i] = !beatStates[i];
                    indicator.classList.toggle('disabled', !beatStates[i]);
                });
                container.appendChild(indicator);
            }
        }

        // Î©îÌä∏Î°úÎÜà Ïû¨ÏÉù
        function startMetronome() {
            if (metronomeInterval) return;
            
            initAudio();
            const bpm = parseInt(document.getElementById('bpm').value);
            const subdivisions = currentSubdivision;
            const isChordMode = document.getElementById('chordMode').checked;
            
            let interval;
            let pattern;
            let subdivisionsPerBeat;
            
            switch (subdivisions) {
                case 'quarter':
                    interval = 60000 / bpm;
                    pattern = [true];
                    subdivisionsPerBeat = 1;
                    break;
                case 'eighth':
                    interval = 60000 / bpm / 2;
                    pattern = [true, true];
                    subdivisionsPerBeat = 2;
                    break;
                case 'triplet':
                    interval = 60000 / bpm / 3;
                    pattern = [true, true, true];
                    subdivisionsPerBeat = 3;
                    break;
                case 'tripletGhost':
                    interval = 60000 / bpm / 3;
                    pattern = [true, false, true];
                    subdivisionsPerBeat = 3;
                    break;
                case 'sixteenth':
                    interval = 60000 / bpm / 4;
                    pattern = [true, true, true, true];
                    subdivisionsPerBeat = 4;
                    break;
                case 'sixteenthSparse':
                    interval = 60000 / bpm / 4;
                    pattern = [true, false, false, true];
                    subdivisionsPerBeat = 4;
                    break;
            }
            
            let subBeat = 0;
            currentBeat = 0; // Î∞ïÏûê Ï¥àÍ∏∞Ìôî
            currentChordBar = 0; // ÏΩîÎìú Ï¥àÍ∏∞Ìôî
            
            // Ï≤´ Î∞ïÏóêÏÑú ÎèôÏãúÏóê ÏãúÏûë
            const indicators = document.querySelectorAll('.beat-indicator');
            indicators.forEach(ind => ind.classList.remove('active'));
            
            // Ï≤´ Î∞ï Ï¶âÏãú Ïû¨ÏÉù
            if (pattern[0] && beatStates[0]) {
                indicators[0].classList.add('active');
                playBeep(1000, 50); // Ï≤´ Î∞ïÏùÄ Ìï≠ÏÉÅ ÎÜíÏùÄ Ïùå
                
                // ÏΩîÎìú Î™®ÎìúÏùº Îïå Ï≤´ ÏΩîÎìúÎèÑ ÎèôÏãúÏóê Ïû¨ÏÉù
                if (isChordMode) {
                    playChordSound(chordProgression[0]);
                }
            }
            
            subBeat = 1; // Îã§Ïùå ÏÑúÎ∏åÎπÑÌä∏Î∂ÄÌÑ∞ ÏãúÏûë
            // Ï≤´ Î∞ïÏùÑ Ïù¥ÎØ∏ Ïû¨ÏÉùÌñàÏúºÎØÄÎ°ú Î∞ïÏûê Ïπ¥Ïö¥ÌÑ∞Îäî Í∑∏ÎåÄÎ°ú 0ÏóêÏÑú ÏãúÏûë
            
            // ÏΩîÎìú ÏßÑÌñâ ÌÉÄÏù¥Î®∏ ÏãúÏûë (ÏΩîÎìú Î™®ÎìúÏùº Îïå)
            if (isChordMode) {
                startChordProgression();
            }
            
            metronomeInterval = setInterval(() => {
                const indicators = document.querySelectorAll('.beat-indicator');
                
                // ÏÜåÎ¶¨ Ïû¨ÏÉù
                const patternIndex = subBeat % subdivisionsPerBeat;
                const beatIndex = Math.floor(subBeat / subdivisionsPerBeat) % beatCount;
                
                // Î∞ïÏûê ÌëúÏãúÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏ (Í∞Å Î∞ïÏùò Ï≤´ Î≤àÏß∏ ÏÑ∏Î∂ÑÌôîÏóêÏÑúÎßå)
                if (patternIndex === 0) {
                    // Ïù¥Ï†Ñ ÌëúÏãú Ï†úÍ±∞
                    indicators.forEach(ind => ind.classList.remove('active'));
                    
                    // ÌòÑÏû¨ Î∞ïÏûê ÌëúÏãú
                    if (beatStates[beatIndex]) {
                        indicators[beatIndex].classList.add('active');
                    }
                }
                
                if (pattern[patternIndex] && beatStates[beatIndex]) {
                    // Í∞Å Î∞ïÏùò Ï≤´ Î≤àÏß∏ ÏÑ∏Î∂ÑÌôîÎäî ÎÜíÏùÄ Ïùå, ÎÇòÎ®∏ÏßÄÎäî ÎÇÆÏùÄ Ïùå
                    const isDownbeat = patternIndex === 0;
                    const isFirstBeat = beatIndex === 0;
                    const soundType = document.getElementById('metronomeSound').value;
                    
                    if (soundType === 'drum') {
                        if (isDownbeat && isFirstBeat) {
                            playDrum('kick', 80); // Ï≤´ Î∞ïÏùÄ ÌÇ•ÎìúÎüº
                        } else if (isDownbeat) {
                            playDrum('snare', 60); // Í∞Å Î∞ïÏùÄ Ïä§ÎÑ§Ïñ¥
                        } else {
                            playDrum('hihat', 40); // ÏÑ∏Î∂ÑÌôîÎäî ÌïòÏù¥Ìñá
                        }
                    } else {
                        if (isDownbeat && isFirstBeat) {
                            playBeep(1000, 50); // Ï≤´ Î∞ïÏùò Ï≤´ ÏÜåÎ¶¨Îäî Í∞ÄÏû• ÎÜíÏùÄ Ïùå
                        } else if (isDownbeat) {
                            playBeep(900, 50); // Í∞Å Î∞ïÏùò Ï≤´ ÏÜåÎ¶¨Îäî ÎÜíÏùÄ Ïùå
                        } else {
                            playBeep(800, 50); // ÏÑ∏Î∂ÑÌôîÎêú ÏÜåÎ¶¨Îäî ÎÇÆÏùÄ Ïùå
                        }
                    }
                }
                
                subBeat++;
            }, interval);
        }

        // Î©îÌä∏Î°úÎÜà Ï†ïÏßÄ
        function stopMetronome() {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
                currentBeat = 0;
                
                const indicators = document.querySelectorAll('.beat-indicator');
                indicators.forEach(ind => ind.classList.remove('active'));
            }
            
            // ÏΩîÎìú ÏßÑÌñâÎèÑ Ìï®Íªò Ï†ïÏßÄ
            stopChordProgression();
        }

        // ÌÉÄÏù¥Î®∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateTimerDisplay() {
            const timerType = document.getElementById('timerType').value;
            const display = document.getElementById('timerDisplay');
            
            if (timerType === 'time') {
                const minutes = Math.floor(timerSeconds / 60);
                const seconds = timerSeconds % 60;
                display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display.textContent = `${timerBars} ÏÜåÏ†à`;
            }
        }

        // ÌÉÄÏù¥Î®∏ ÏãúÏûë
        function startTimer() {
            const timerType = document.getElementById('timerType').value;
            
            if (timerType === 'time') {
                timerSeconds = parseInt(document.getElementById('timeTimer').value) * 60;
            } else {
                timerBars = parseInt(document.getElementById('barsTimer').value);
            }
            
            updateTimerDisplay();
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (timerType === 'time') {
                    timerSeconds--;
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        playBeep(1200, 500); // ÏôÑÎ£å Ïã†Ìò∏
                    }
                } else {
                    // ÏÜåÏ†à ÌÉÄÏù¥Î®∏Îäî Î©îÌä∏Î°úÎÜàÍ≥º Ïó∞ÎèôÌïòÏó¨ Í≥ÑÏÇ∞
                    const bpm = parseInt(document.getElementById('bpm').value);
                    const timeSignature = document.getElementById('timeSignature').value;
                    const [numerator] = timeSignature.split('/').map(Number);
                    const barDuration = (60000 / bpm) * numerator;
                    
                    // Í∞ÑÎã®Ìûà 1Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨
                    if (metronomeInterval && currentBeat === 0) {
                        timerBars--;
                        if (timerBars <= 0) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                            playBeep(1200, 500);
                        }
                    }
                }
                updateTimerDisplay();
            }, 1000);
        }

        // ÏΩîÎìú ÏßÑÌñâ Ïû¨ÏÉù
        function startChordProgression() {
            if (chordInterval) return;
            
            const bpm = parseInt(document.getElementById('bpm').value);
            const beatDuration = 60000 / bpm;
            
            currentChordIndex = 0;
            currentChordBeat = 0;
            
            // Ï≤´ ÏΩîÎìú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            updateCurrentChordDisplay();
            
            // Ï≤´ ÏΩîÎìúÎäî Î©îÌä∏Î°úÎÜàÏóêÏÑú Ïù¥ÎØ∏ Ïû¨ÏÉùÌñàÏúºÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî ÌÉÄÏù¥Î®∏Îßå ÏÑ§Ï†ï
            chordInterval = setInterval(() => {
                currentChordBeat++;
                
                // ÌòÑÏû¨ ÏΩîÎìúÏùò ÏßÄÏÜçÏãúÍ∞ÑÏù¥ ÎÅùÎÇ¨ÎäîÏßÄ ÌôïÏù∏
                if (currentChordBeat >= chordProgression[currentChordIndex].duration) {
                    currentChordIndex = (currentChordIndex + 1) % chordProgression.length;
                    currentChordBeat = 0;
                    playChordSound(chordProgression[currentChordIndex]);
                    updateCurrentChordDisplay();
                }
            }, beatDuration);
        }
        
        // ÌòÑÏû¨ Ïó∞Ï£º Ï§ëÏù∏ ÏΩîÎìú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateCurrentChordDisplay() {
            // ÏÑ§Ï†ï Ìå®ÎÑêÏùò ÌòÑÏû¨ ÏΩîÎìú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            const currentChordDisplay = document.getElementById('currentChordDisplay');
            if (currentChordDisplay) {
                currentChordDisplay.textContent = getChordName(chordProgression[currentChordIndex]);
            }
            
            // ÏΩîÎìú ÏßÑÌñâ ÌëúÏãúÏóêÏÑú ÌòÑÏû¨ ÏΩîÎìú ÌïòÏù¥ÎùºÏù¥Ìä∏
            const chordItems = document.querySelectorAll('.chord-item');
            chordItems.forEach((item, index) => {
                if (index === currentChordIndex) {
                    item.classList.add('playing');
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        // ÏΩîÎìú Íµ¨ÏÑ±Ïùå Í≥ÑÏÇ∞
        function getChordNotes(chordObj) {
            const { root, quality, seventh, tensions } = chordObj;
            const rootIndex = getNoteIndex(root);
            let intervals = [];
            
            // Í∏∞Î≥∏ Ìä∏ÎùºÏù¥Ïñ¥Îìú
            switch (quality) {
                case 'major':
                    intervals = [0, 4, 7]; // 1, 3, 5
                    break;
                case 'minor':
                    intervals = [0, 3, 7]; // 1, b3, 5
                    break;
                case 'augmented':
                    intervals = [0, 4, 8]; // 1, 3, #5
                    break;
                case 'diminished':
                    intervals = [0, 3, 6]; // 1, b3, b5
                    break;
                case 'halfDiminished':
                    intervals = [0, 3, 6]; // 1, b3, b5 (ÌïòÌîÑÎîîÎØ∏ÎãàÏãúÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú m7b5)
                    break;
            }
            
            // ÏÑ∏Î∏êÏä§ Ï∂îÍ∞Ä
            if (seventh === 'dominant') {
                intervals.push(10); // b7
            } else if (seventh === 'major7') {
                intervals.push(11); // 7
            }
            
            // ÎîîÎØ∏ÎãàÏãúÏôÄ ÌïòÌîÑÎîîÎØ∏ÎãàÏãúÏùò Í∏∞Î≥∏ ÏÑ∏Î∏êÏä§ Ï≤òÎ¶¨
            if (quality === 'diminished' && seventh === '') {
                intervals.push(9); // bb7 (ÎîîÎØ∏ÎãàÏãúÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú ÎçîÎ∏îÌîåÎû´7)
            } else if (quality === 'halfDiminished' && seventh === '') {
                intervals.push(10); // b7 (ÌïòÌîÑÎîîÎØ∏ÎãàÏãúÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú m7b5)
            }
            
            // ÌÖêÏÖò Ï∂îÍ∞Ä
            tensions.forEach(tension => {
                switch (tension) {
                    case '9': intervals.push(2); break;
                    case 'b9': intervals.push(1); break;
                    case '#9': intervals.push(3); break;
                    case '11': intervals.push(5); break;
                    case '#11': intervals.push(6); break;
                    case '13': intervals.push(9); break;
                    case 'b13': intervals.push(8); break;
                }
            });
            
            // ÏùåÌëúÎ°ú Î≥ÄÌôò (Ìïú Ïò•ÌÉÄÎ∏å ÎÇ¥ÏóêÏÑú)
            return intervals.map(interval => notes[(rootIndex + interval) % 12]);
        }
        
        // ÏΩîÎìú ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù (Î≤†Ïù¥Ïä§ + ÌîºÏïÑÎÖ∏)
        function playChordSound(chordObj) {
            if (!audioContext) return;
            
            const chordNotes = getChordNotes(chordObj);
            const rootFreq = getNoteFrequency(chordObj.root, 2); // Î≤†Ïù¥Ïä§Îäî 2Ïò•ÌÉÄÎ∏å
            
            // Î≤†Ïù¥Ïä§ Ïùå Ïû¨ÏÉù
            playBass(rootFreq, 800);
            
            // ÌîºÏïÑÎÖ∏ ÏΩîÎìú Ïû¨ÏÉù (4Ïò•ÌÉÄÎ∏å)
            chordNotes.forEach((note, index) => {
                setTimeout(() => {
                    const freq = getNoteFrequency(note, 4);
                    playPianoNote(freq, 600);
                }, index * 50); // ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥Î°ú ÏïÑÎ•¥ÌéòÏßÄÏò§ Ìö®Í≥º
            });
        }
        
        // ÌîºÏïÑÎÖ∏ Ïùå Ïû¨ÏÉù
        function playPianoNote(frequency, duration = 500) {
            if (!audioContext) return;
            
            const pianoVol = document.getElementById('pianoVolume').value / 100;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'triangle';
            
            gainNode.gain.setValueAtTime(0.15 * pianoVol, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }
        
        // ÏΩîÎìú Ïù¥Î¶Ñ ÏÉùÏÑ±
        function getChordName(chordObj) {
            const { root, quality, seventh, tensions } = chordObj;
            let name = root;
            
            // ÌÄÑÎ¶¨Ìã∞ ÌëúÍ∏∞
            if (quality === 'minor') name += 'm';
            else if (quality === 'augmented') name += '(#5)';
            else if (quality === 'diminished') name += '¬∞';
            else if (quality === 'halfDiminished') name += '√∏';
            
            // ÏÑ∏Î∏êÏä§ ÌëúÍ∏∞
            if (seventh === 'dominant') {
                name += '7';
            } else if (seventh === 'major7') {
                name += '‚ñ≥7';
            } else if (quality === 'diminished' && seventh === '') {
                name += '7'; // ÎîîÎØ∏ÎãàÏãúÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú dim7
            } else if (quality === 'halfDiminished' && seventh === '') {
                name += '7'; // ÌïòÌîÑÎîîÎØ∏ÎãàÏãúÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú m7b5
            }
            
            // ÌÖêÏÖò ÌëúÍ∏∞
            if (tensions.length > 0) {
                name += '(' + tensions.join(',') + ')';
            }
            
            return name;
        }

        // ÏΩîÎìú UI ÏÉùÏÑ±
        function createChordElement(chordObj, index) {
            const chordDiv = document.createElement('div');
            chordDiv.className = 'chord-item';
            chordDiv.setAttribute('data-chord-index', index);
            chordDiv.innerHTML = `
                <div class="chord-duration-controls">
                    <div class="control-btn" onclick="adjustChordDuration(${index}, -1)">-</div>
                    <div class="control-btn" onclick="adjustChordDuration(${index}, 1)">+</div>
                </div>
                <div class="chord-controls">
                    <div class="control-btn delete" onclick="deleteChord(${index})">√ó</div>
                </div>
                <div class="chord-name-display">${getChordName(chordObj)}</div>
                <div class="grid grid-cols-2 gap-1 mb-1">
                    <div>
                        <select class="chord-root w-full input-bg rounded px-1 py-1 text-xs border" onchange="updateChord(${index})">
                            ${notes.map(note => `<option value="${note}" ${note === chordObj.root ? 'selected' : ''}>${note}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <select class="chord-quality w-full input-bg rounded px-1 py-1 text-xs border" onchange="updateChord(${index})">
                            <option value="major" ${chordObj.quality === 'major' ? 'selected' : ''}></option>
                            <option value="minor" ${chordObj.quality === 'minor' ? 'selected' : ''}>m</option>
                            <option value="augmented" ${chordObj.quality === 'augmented' ? 'selected' : ''}>(#5)</option>
                            <option value="diminished" ${chordObj.quality === 'diminished' ? 'selected' : ''}>¬∞</option>
                            <option value="halfDiminished" ${chordObj.quality === 'halfDiminished' ? 'selected' : ''}>√∏</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-1 mb-1">
                    <div>
                        <select class="chord-seventh w-full input-bg rounded px-1 py-1 text-xs border" onchange="updateChord(${index})">
                            <option value="" ${chordObj.seventh === '' ? 'selected' : ''}>-</option>
                            <option value="dominant" ${chordObj.seventh === 'dominant' ? 'selected' : ''}>7</option>
                            <option value="major7" ${chordObj.seventh === 'major7' ? 'selected' : ''}>‚ñ≥7</option>
                        </select>
                    </div>
                    <div>
                        <select class="chord-tension w-full input-bg rounded px-1 py-1 text-xs border" onchange="addTension(${index}, this.value); this.value='';">
                            <option value="">+</option>
                            <option value="9">9</option>
                            <option value="b9">b9</option>
                            <option value="#9">#9</option>
                            <option value="11">11</option>
                            <option value="#11">#11</option>
                            <option value="13">13</option>
                            <option value="b13">b13</option>
                        </select>
                    </div>
                </div>
                <div class="tensions-display text-xs mb-1">
                    ${chordObj.tensions.map(t => `<span class="inline-block bg-blue-100 text-blue-800 px-1 py-0 rounded text-xs cursor-pointer" onclick="removeTension(${index}, '${t}')">${t}√ó</span>`).join(' ')}
                </div>
                <div class="chord-duration-display text-xs">${chordObj.duration}Î∞ï</div>
            `;
            return chordDiv;
        }
        
        // ÏΩîÎìú ÏßÑÌñâ UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateChordProgressionUI() {
            const container = document.getElementById('chordContainer');
            container.innerHTML = '';
            
            chordProgression.forEach((chord, index) => {
                container.appendChild(createChordElement(chord, index));
            });
        }
        
        // ÏΩîÎìú ÏóÖÎç∞Ïù¥Ìä∏
        function updateChord(index) {
            const chordDiv = document.querySelectorAll('.chord-item')[index];
            const root = chordDiv.querySelector('.chord-root').value;
            const quality = chordDiv.querySelector('.chord-quality').value;
            const seventh = chordDiv.querySelector('.chord-seventh').value;
            
            chordProgression[index] = {
                ...chordProgression[index],
                root,
                quality,
                seventh
            };
            
            updateChordProgressionUI();
        }
        
        // ÌÖêÏÖò Ï∂îÍ∞Ä
        function addTension(index, tension) {
            if (tension && !chordProgression[index].tensions.includes(tension)) {
                chordProgression[index].tensions.push(tension);
                updateChordProgressionUI();
            }
        }
        
        // ÌÖêÏÖò Ï†úÍ±∞
        function removeTension(index, tension) {
            chordProgression[index].tensions = chordProgression[index].tensions.filter(t => t !== tension);
            updateChordProgressionUI();
        }
        
        // ÏΩîÎìú ÏßÄÏÜçÏãúÍ∞Ñ Ï°∞Ï†ï
        function adjustChordDuration(index, delta) {
            const newDuration = Math.max(1, chordProgression[index].duration + delta);
            chordProgression[index].duration = newDuration;
            updateChordProgressionUI();
        }
        
        // ÏΩîÎìú Ï∂îÍ∞Ä
        function addChord() {
            chordProgression.push({
                root: 'C',
                quality: 'major',
                seventh: '',
                tensions: [],
                duration: 4
            });
            updateChordProgressionUI();
        }
        
        // ÏΩîÎìú ÏÇ≠Ï†ú
        function deleteChord(index) {
            if (chordProgression.length > 1) {
                chordProgression.splice(index, 1);
                updateChordProgressionUI();
            }
        }

        // ÏΩîÎìú ÏßÑÌñâ Ï†ïÏßÄ
        function stopChordProgression() {
            if (chordInterval) {
                clearInterval(chordInterval);
                chordInterval = null;
                currentChordIndex = 0;
                currentChordBeat = 0;
                
                // ÌòÑÏû¨ ÏΩîÎìú ÌëúÏãú Ï¥àÍ∏∞Ìôî
                const currentChordDisplay = document.getElementById('currentChordDisplay');
                if (currentChordDisplay) {
                    currentChordDisplay.textContent = '-';
                }
                
                // Î™®Îì† ÏΩîÎìú ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞
                const chordItems = document.querySelectorAll('.chord-item');
                chordItems.forEach(item => {
                    item.classList.remove('playing');
                });
            }
        }

        // ÌÖåÎßà Î≥ÄÍ≤Ω Ìï®Ïàò
        function toggleTheme() {
            const body = document.getElementById('body');
            const isDark = document.getElementById('darkMode').checked;
            
            if (isDark) {
                body.className = 'dark-theme min-h-screen p-4 transition-colors duration-300';
            } else {
                body.className = 'light-theme min-h-screen p-4 transition-colors duration-300';
            }
        }

        // ÏùåÌëú ÏïÑÏù¥ÏΩò Ï¥àÍ∏∞Ìôî
        function initNoteIcons() {
            const noteIcons = document.querySelectorAll('.note-icon');
            noteIcons.forEach(icon => {
                const noteType = icon.getAttribute('data-note');
                const iconContent = createNoteIcon(noteType);
                icon.innerHTML = iconContent.innerHTML;
            });
        }

        // Ïû¨ÏÉù ÏòµÏÖò Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        function handleSubdivisionClick(button) {
            // Î™®Îì† Î≤ÑÌäºÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.subdivision-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÌÅ¥Î¶≠Îêú Î≤ÑÌäºÏóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            button.classList.add('active');
            
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïû¨ÏÉù ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
            currentSubdivision = button.getAttribute('data-value');
            
            // Î©îÌä∏Î°úÎÜàÏù¥ Ïû¨ÏÉù Ï§ëÏù¥Î©¥ Ï¶âÏãú Î∞òÏòÅ
            if (metronomeInterval) {
                stopMetronome();
                startMetronome();
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        document.addEventListener('DOMContentLoaded', () => {
            createFretboard();
            updateBeatIndicators();
            updateTimerDisplay();
            initNoteIcons();
            updateChordProgressionUI();
            
            // ÏïÖÍ∏∞ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            document.getElementById('instrumentSelect').addEventListener('change', switchInstrument);
            
            // Ïä§ÏºÄÏùº Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            document.getElementById('keyCenter').addEventListener('change', updateScale);
            document.getElementById('scaleType').addEventListener('change', updateScale);
            
            // ÏßÄÌåê Î™®Îìú ÌÜ†Í∏Ä (Í∏∞ÌÉÄ)
            document.getElementById('fretboardMode').addEventListener('change', updateScale);
            
            // Î∞îÏù¥Ïò¨Î¶∞ Î™®Îìú ÌÜ†Í∏Ä
            document.getElementById('violinMode').addEventListener('change', updateScale);
            
            // Îã§ÌÅ¨Î™®Îìú ÌÜ†Í∏Ä
            document.getElementById('darkMode').addEventListener('change', toggleTheme);
            
            // ÏΩîÎìú Î™®Îìú ÌÜ†Í∏Ä
            document.getElementById('chordMode').addEventListener('change', (e) => {
                const chordSettings = document.getElementById('chordSettings');
                const chordProgressionDisplay = document.getElementById('chordProgressionDisplay');
                
                if (e.target.checked) {
                    chordSettings.style.display = 'block';
                    chordProgressionDisplay.style.display = 'block';
                } else {
                    chordSettings.style.display = 'none';
                    chordProgressionDisplay.style.display = 'none';
                }
            });
            
            // ÏΩîÎìú Ï∂îÍ∞Ä Î≤ÑÌäº
            document.getElementById('addChord').addEventListener('click', addChord);
            
            // Î∞ïÏûêÌëú Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            document.getElementById('timeSignature').addEventListener('change', updateBeatIndicators);
            
            // Î©îÌä∏Î°úÎÜà Î≤ÑÌäº
            document.getElementById('metronomePlay').addEventListener('click', startMetronome);
            document.getElementById('metronomeStop').addEventListener('click', stopMetronome);
            
            // Ïû¨ÏÉù ÏòµÏÖò Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.subdivision-btn').forEach(button => {
                button.addEventListener('click', () => handleSubdivisionClick(button));
            });
            
            // BPM Î≥ÄÍ≤Ω Ïãú Ï¶âÏãú Î∞òÏòÅ
            document.getElementById('bpm').addEventListener('input', () => {
                if (metronomeInterval) {
                    stopMetronome();
                    startMetronome();
                }
            });
            
            // ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï
            document.getElementById('timerType').addEventListener('change', (e) => {
                const timeDiv = document.getElementById('timeTimerDiv');
                const barsDiv = document.getElementById('barsTimerDiv');
                
                if (e.target.value === 'time') {
                    timeDiv.style.display = 'block';
                    barsDiv.style.display = 'none';
                } else {
                    timeDiv.style.display = 'none';
                    barsDiv.style.display = 'block';
                }
                updateTimerDisplay();
            });
            
            document.getElementById('timeTimer').addEventListener('change', updateTimerDisplay);
            document.getElementById('barsTimer').addEventListener('change', updateTimerDisplay);
            document.getElementById('timerStart').addEventListener('click', startTimer);
            
            // ÏùåÎüâ Ìå®ÎÑê ÌÜ†Í∏Ä
            document.getElementById('volumeToggle').addEventListener('click', () => {
                const panel = document.getElementById('volumePanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            
            // ÏùåÎüâ Ìå®ÎÑê Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('volumePanel');
                const toggle = document.getElementById('volumeToggle');
                if (!panel.contains(e.target) && !toggle.contains(e.target)) {
                    panel.style.display = 'none';
                }
            });
            
            // ÏùåÎüâ Ïä¨ÎùºÏù¥Îçî Ïù¥Î≤§Ìä∏
            document.getElementById('metronomeVolume').addEventListener('input', (e) => {
                document.getElementById('metronomeVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('bassVolume').addEventListener('input', (e) => {
                document.getElementById('bassVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('pianoVolume').addEventListener('input', (e) => {
                document.getElementById('pianoVolumeDisplay').textContent = e.target.value;
            });
            document.getElementById('instrumentVolume').addEventListener('input', (e) => {
                document.getElementById('instrumentVolumeDisplay').textContent = e.target.value;
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973348f8b05e80b7',t:'MTc1NTg3NTMwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
