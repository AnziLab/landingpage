<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Metronome</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc',
                            400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca',
                            800: '#3730a3', 900: '#312e81'
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>

    <style>
        :root {
            --panel: rgba(255, 255, 255, 0.72);
            --panel-border: rgba(0, 0, 0, 0.06);
            --panel-shadow: 0 10px 30px rgba(17, 24, 39, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            --surface: #f6f7fb;
            --text: #0f172a;
            --muted: #6b7280;
            --dot: #ef4444;
            --dot-accent: #f87171;
        }
        .dark:root {
            --panel: rgba(17, 24, 39, 0.72);
            --panel-border: rgba(255, 255, 255, 0.08);
            --panel-shadow: 0 10px 30px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.04);
            --surface: #0b0d12;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --dot: #ff3b30;
            --dot-accent: #ff6b60;
        }
        body {
            min-height: 100vh;
            background: radial-gradient(1100px 600px at 10% -10%, rgba(99, 102, 241, 0.12), transparent 60%),
                        radial-gradient(900px 600px at 120% 20%, rgba(16, 185, 129, 0.10), transparent 60%),
                        linear-gradient(180deg, var(--surface), var(--surface));
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }
        .glass {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            backdrop-filter: saturate(180%) blur(10px);
            box-shadow: var(--panel-shadow);
        }
        #stage {
            background: rgba(17, 17, 17, 0.08);
            transition: border-color 200ms ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .dark #stage { background: rgba(255, 255, 255, 0.05); }
        #stage.running { border-color: var(--dot-accent); }

        .beat-dot {
            width: 14px; height: 14px;
            border-radius: 9999px;
            background: var(--dot);
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.45);
            transform: scale(0.9);
            transition: transform 120ms ease, opacity 120ms ease;
            opacity: 0.5;
        }
        .beat-dot.active {
            opacity: 1;
            transform: scale(1.2);
            background: var(--dot-accent);
            animation: pulse 250ms ease-out;
        }
        @keyframes pulse {
            0%   { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.55); }
            100% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .panel-btn {
            @apply flex items-center justify-center text-sm font-semibold rounded-lg px-3 py-2 select-none;
            background: rgba(17, 17, 17, 0.05);
            border: 1px solid var(--panel-border);
        }
        .dark .panel-btn { background: rgba(255, 255, 255, 0.06); }
        .range {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 9999px; background: #e5e7eb;
        }
        .dark .range { background: #374151; }
        .range::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 9999px; background: #fff; border: 2px solid #4f46e5; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
        }
        .dark .range::-webkit-slider-thumb { background: #111827; border-color: #818cf8; }
        .range::-moz-range-thumb {
            width: 18px; height: 18px; border-radius: 9999px; background: #fff; border: 2px solid #4f46e5; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
        }
        .icon-btn { @apply p-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 transition; }
    </style>
</head>

<body class="min-h-full flex items-start justify-center p-4">
    <div class="w-full max-w-xs glass rounded-3xl p-3 space-y-3">
        <div class="flex items-center justify-between">
            <h1 class="text-lg font-extrabold tracking-tight">메트로놈</h1>
            <div class="flex items-center gap-1.5">
                <button id="tapBtn" class="icon-btn" title="탭 템포">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-80" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2a1 1 0 112 0v7a1 1 0 11-2 0V2z"/><path d="M5.636 5.636a1 1 0 011.414 0L12 10.586l4.95-4.95a1 1 0 011.414 1.415l-5.657 5.656a1 1 0 01-1.414 0L5.636 7.05a1 1 0 010-1.414z"/><path d="M4 19a1 1 0 100 2h16a1 1 0 100-2H4z"/></svg>
                </button>
                <button id="themeToggle" class="icon-btn" title="라이트/다크 전환" aria-label="테마 전환">
                    <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M12 18a6 6 0 100-12 6 6 0 000 12z"/><path d="M12 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm0 18a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM4.222 5.636a1 1 0 011.414-1.414l.707.707a1 1 0 11-1.414 1.414l-.707-.707zM17.657 19.071a1 1 0 011.414-1.414l.707.707a1 1 0 11-1.414 1.414l-.707-.707zM2 13a1 1 0 110-2h1a1 1 0 110 2H2zm18 0a1 1 0 110-2h1a1 1 0 110 2h-1zM4.222 18.364l.707-.707A1 1 0 116.343 19.07l-.707.708a1 1 0 11-1.414-1.414zM17.657 4.93l.707-.707A1 1 0 1120.778 5.64l-.707.707A1 1 0 1117.657 4.93z"/></svg>
                    <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"/></svg>
                </button>
            </div>
        </div>

        <div id="stage" class="rounded-2xl h-28 flex items-center justify-center p-4">
            <div id="dots" class="flex items-center justify-center gap-3"></div>
        </div>

        <div class="glass rounded-2xl p-3">
            <div class="grid grid-cols-[auto_1fr_auto] items-center gap-3 mb-2">
                <button id="tempoDown" class="panel-btn">-</button>
                <div class="text-center">
                    <div class="text-4xl font-extrabold tabular-nums leading-none" id="bpmText">100</div>
                    <div class="text-[10px] text-gray-500 dark:text-gray-400 mt-0.5" id="tempoLabel">Moderato</div>
                </div>
                <button id="tempoUp" class="panel-btn">+</button>
            </div>
            <input id="tempoSlider" type="range" min="40" max="240" step="1" value="100" class="range">
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div class="panel-btn flex items-center justify-center gap-2">
                <button id="numMinus" class="px-1">-</button>
                <div id="timeText" class="text-lg font-bold tabular-nums">4/4</div>
                <button id="numPlus" class="px-1">+</button>
                <div class="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>
                <button id="denomBtn" class="text-sm">분모 4</button>
            </div>

            <div class="grid grid-cols-2 gap-2">
                 <button id="subdivBtn" class="panel-btn">
                    <span class="mr-1.5">분할</span>
                    <span id="subdivText" class="opacity-80">x1</span>
                </button>
                <button id="resetBtn" class="panel-btn" title="초기화">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6l5 5V7a5 5 0 110 10 5 5 0 01-4.472-2.777 1 1 0 00-1.764.944A7 7 0 1012 5z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Theme handling
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        const savedTheme = localStorage.getItem('theme');
        const root = document.documentElement;
        function applyTheme(mode) {
            if (mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
            document.getElementById('themeIconSun').classList.toggle('hidden', mode !== 'light');
            document.getElementById('themeIconMoon').classList.toggle('hidden', mode === 'light');
        }
        applyTheme(savedTheme || (prefersDark.matches ? 'dark' : 'light'));
        document.getElementById('themeToggle').addEventListener('click', () => {
            const isDark = root.classList.contains('dark');
            const next = isDark ? 'light' : 'dark';
            applyTheme(next);
            localStorage.setItem('theme', next);
        });

        // Elements
        const stage = document.getElementById('stage');
        const dotsWrap = document.getElementById('dots');
        const timeText = document.getElementById('timeText');
        const subdivBtn = document.getElementById('subdivBtn');
        const subdivText = document.getElementById('subdivText');
        const resetBtn = document.getElementById('resetBtn');
        const numMinus = document.getElementById('numMinus');
        const numPlus = document.getElementById('numPlus');
        const denomBtn = document.getElementById('denomBtn');

        const bpmText = document.getElementById('bpmText');
        const tempoLabel = document.getElementById('tempoLabel');
        const tempoDown = document.getElementById('tempoDown');
        const tempoUp = document.getElementById('tempoUp');
        const tempoSlider = document.getElementById('tempoSlider');
        const tapBtn = document.getElementById('tapBtn');

        // State
        let numerator = 4;
        let denominator = 4;
        let subdivision = 1;
        let bpm = 100;
        let running = false;
        let currentBeat = 0;
        let subIndex = 0;

        // WebAudio scheduler
        let ctx = null;
        let lookahead = 25 / 1000;
        let scheduleAhead = 0.12;
        let nextNoteTime = 0;
        let timerID = null;

        function ensureAudio() {
            if (!ctx) {
                ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playClick(time, kind = 'normal') {
            if (!ctx) return;
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            let freq = 1000, peak = 0.6, decay = 0.04;
            if (kind === 'accent') { freq = 1400; peak = 0.8; decay = 0.05; }
            if (kind === 'sub') { freq = 800; peak = 0.35; decay = 0.03; }

            osc.frequency.value = freq;
            osc.type = 'square';
            g.gain.setValueAtTime(0.0001, time);
            g.gain.exponentialRampToValueAtTime(Math.max(peak, 0.0001), time + 0.002);
            g.gain.exponentialRampToValueAtTime(0.0001, time + decay);

            osc.connect(g);
            g.connect(ctx.destination);
            osc.start(time);
            osc.stop(time + decay + 0.005);
        }

        function secondsPerSubBeat() {
            const secondsPerBeat = 60 / bpm * (4 / denominator);
            return secondsPerBeat / subdivision;
        }

        function scheduleNotes() {
            while (nextNoteTime < ctx.currentTime + scheduleAhead) {
                let kind = 'sub';
                if (subIndex === 0) {
                    kind = (currentBeat === 0) ? 'accent' : 'normal';
                }
                playClick(nextNoteTime, kind);
                requestAnimationFrame(() => highlightBeat(currentBeat, subIndex));
                advanceNote();
            }
        }

        function advanceNote() {
            subIndex++;
            if (subIndex >= subdivision) {
                subIndex = 0;
                currentBeat = (currentBeat + 1) % numerator;
            }
            nextNoteTime += secondsPerSubBeat();
        }

        function scheduler() {
            scheduleNotes();
            timerID = setTimeout(scheduler, lookahead * 1000);
        }

        function start() {
            ensureAudio();
            ctx.resume && ctx.resume();
            running = true;
            stage.classList.add('running');
            currentBeat = 0;
            subIndex = 0;
            nextNoteTime = ctx.currentTime + 0.08;
            scheduler();
        }

        function stop() {
            running = false;
            stage.classList.remove('running');
            if (timerID) clearTimeout(timerID);
            timerID = null;
            // BUG FIX: Reset state on stop for a clean start next time
            currentBeat = 0;
            subIndex = 0;
            clearBeatHighlights();
        }

        function toggle() {
            running ? stop() : start();
        }

        function renderDots() {
            dotsWrap.innerHTML = '';
            const gap = numerator >= 7 ? 6 : 12;
            dotsWrap.style.gap = gap + 'px';
            for (let i = 0; i < numerator; i++) {
                const d = document.createElement('div');
                d.className = 'beat-dot';
                dotsWrap.appendChild(d);
            }
        }

        function clearBeatHighlights() {
            [...dotsWrap.children].forEach(el => el.classList.remove('active'));
        }

        function highlightBeat(beatIdx, subIdx) {
            if (subIdx !== 0) return;
            clearBeatHighlights();
            const el = dotsWrap.children[beatIdx];
            if (el) el.classList.add('active');
        }

        function updateUI() {
            timeText.textContent = `${numerator}/${denominator}`;
            subdivText.textContent = `x${subdivision}`;
            denomBtn.textContent = `분모 ${denominator}`;
            bpmText.textContent = Math.round(bpm);
            tempoLabel.textContent = tempoMarking(bpm);
            tempoSlider.value = bpm;
            renderDots();
        }

        function tempoMarking(bpm) {
            if (bpm < 40) return 'Grave';
            if (bpm < 56) return 'Largo';
            if (bpm < 72) return 'Adagio';
            if (bpm < 84) return 'Andante';
            if (bpm < 100) return 'Andantino';
            if (bpm < 120) return 'Moderato';
            if (bpm < 156) return 'Allegro';
            if (bpm < 176) return 'Vivace';
            if (bpm < 200) return 'Presto';
            return 'Prestissimo';
        }

        function holdRepeat(el, onStep, stepDelay = 120, accelerate = true) {
            let t = null, speed = stepDelay, active = false;
            const start = () => {
                if (active) return;
                active = true;
                onStep();
                let count = 0;
                t = setInterval(() => {
                    onStep();
                    if (accelerate && ++count % 6 === 0 && speed > 40) {
                        clearInterval(t);
                        speed -= 10;
                        t = setInterval(onStep, speed);
                    }
                }, speed);
            };
            const stop = () => { active = false; clearInterval(t); t = null; speed = stepDelay; };
            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); start(); }, { passive: false });
            window.addEventListener('mouseup', stop);
            window.addEventListener('touchend', stop);
            window.addEventListener('touchcancel', stop);
            el.addEventListener('click', (e) => e.preventDefault());
        }

        // Events
        stage.addEventListener('click', toggle);

        resetBtn.addEventListener('click', () => {
            numerator = 4; denominator = 4; subdivision = 1; setBpm(100);
            if (running) stop();
            updateUI();
        });
        
        numMinus.addEventListener('click', () => { numerator = Math.max(1, numerator - 1); updateUI(); });
        numPlus.addEventListener('click', () => { numerator = Math.min(16, numerator + 1); updateUI(); });

        subdivBtn.addEventListener('click', () => {
            subdivision++;
            if (subdivision > 4) subdivision = 1;
            subdivText.textContent = `x${subdivision}`;
        });

        denomBtn.addEventListener('click', () => {
            const order = [2, 4, 8];
            const idx = order.indexOf(denominator);
            denominator = order[(idx + 1) % order.length];
            updateUI();
        });

        function setBpm(v) {
            bpm = Math.min(240, Math.max(40, v));
            bpmText.textContent = Math.round(bpm);
            tempoLabel.textContent = tempoMarking(bpm);
            tempoSlider.value = bpm;
        }

        tempoSlider.addEventListener('input', (e) => setBpm(parseFloat(e.target.value)));
        holdRepeat(tempoUp, () => setBpm(bpm + 1));
        holdRepeat(tempoDown, () => setBpm(bpm - 1));

        const taps = [];
        tapBtn.addEventListener('click', () => {
            const now = performance.now();
            taps.push(now);
            while (taps.length > 6) taps.shift();
            if (taps.length >= 2) {
                let sum = 0; let cnt = 0;
                for (let i = 1; i < taps.length; i++) {
                    sum += (taps[i] - taps[i - 1]); cnt++;
                }
                const avgMs = sum / cnt;
                setBpm(60000 / avgMs);
            }
            tapBtn.classList.add('ring-2', 'ring-brand-500');
            setTimeout(() => tapBtn.classList.remove('ring-2', 'ring-brand-500'), 120);
        });

        // Init
        updateUI();
    </script>
</body>
</html>
