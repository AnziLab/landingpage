<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Dashboard Premium Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <style>
        /* --- Global Variables --- */
        :root {
            --bg-color: #0F0C29;
            --bg-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.85);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --accent-color: #ff00cc;
            --accent-glow: rgba(255, 0, 204, 0.5);
            --focus-border: #00d2ff; /* ë¦¬ëª¨ì»¨ í¬ì»¤ìŠ¤ ìƒ‰ìƒ */
            --font-heading: 'Outfit', sans-serif;
            --font-body: 'Noto Sans KR', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }

        body {
            background: var(--bg-gradient);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 0, 204, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 210, 255, 0.15) 0%, transparent 40%),
                var(--bg-gradient);
            color: var(--text-primary);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column; padding: 3rem;
        }

        /* --- Top Bar --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            height: 100px; margin-bottom: 2rem;
        }

        .info-group { display: flex; align-items: center; gap: 3rem; }

        .clock {
            font-family: var(--font-heading);
            font-size: 3.5rem; font-weight: 800; letter-spacing: -1px;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }

        .weather-widget { display: flex; flex-direction: column; justify-content: center; }
        .weather-main { font-size: 1.8rem; font-weight: 700; display: flex; align-items: center; gap: 0.8rem; }
        .weather-sub { font-size: 1.1rem; color: var(--text-secondary); margin-top: 2px; }

        /* --- Music Player Panel --- */
        .music-player-panel {
            display: flex; align-items: center; gap: 2rem;
            background: rgba(20, 10, 40, 0.4);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(25px);
            padding: 1rem 2rem;
            border-radius: 24px;
            width: 600px;
        }

        .music-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }

        /* íë¥´ëŠ” í…ìŠ¤íŠ¸ (Marquee) */
        .marquee-container {
            width: 100%; overflow: hidden; white-space: nowrap; margin-bottom: 0.5rem;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .music-title {
            display: inline-block; font-size: 1.4rem; font-weight: 700; color: var(--text-primary);
            padding-left: 0; animation: none; /* JSë¡œ ì œì–´ */
        }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* ìŒì•… ì§„í–‰ë°” */
        .progress-container {
            width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;
        }
        .progress-bar { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.5s linear; }

        .music-controls { display: flex; align-items: center; gap: 1rem; }
        .control-btn {
            background: rgba(255, 255, 255, 0.05); border: none; color: var(--text-secondary);
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .material-symbols-rounded { font-size: 24px; }
        .control-btn.main-action {
            width: 56px; height: 56px; color: #fff;
            background: var(--accent-color); box-shadow: 0 0 20px var(--accent-glow);
        }
        .control-btn.main-action .material-symbols-rounded { font-size: 32px; }

        /* --- Main Content --- */
        .dashboard-body {
            flex: 1;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 32px; backdrop-filter: blur(30px);
            padding: 2.5rem; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .section-title {
            font-family: var(--font-heading); font-size: 2.2rem; font-weight: 600;
            margin-bottom: 1.5rem; color: var(--text-secondary);
            border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* [NEW] ì§‘ì•ˆì¼ ì§„í–‰ë¥  ë°” (ì´ˆë¡ìƒ‰) */
        .task-progress-wrapper {
            width: 100%; height: 26px;
            background: rgba(255, 255, 255, 0.1); border-radius: 13px;
            margin-bottom: 1.5rem; position: relative; overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #238636, #2ea043); /* ì´ˆë¡ìƒ‰ */
            width: 0%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 15px rgba(46, 160, 67, 0.5);
        }
        .task-progress-text {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.95rem; font-weight: 700; color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .tasks-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;
            overflow-y: auto; padding: 0.5rem; align-content: start;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent; border-radius: 20px;
            padding: 1.5rem 1.8rem; font-size: 1.8rem; font-weight: 500;
            display: flex; align-items: center; transition: all 0.1s;
        }
        .task-bullet {
            min-width: 14px; height: 14px; border-radius: 50%;
            background: var(--accent-color); margin-right: 1.2rem;
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .task-completed { opacity: 0.5; text-decoration: line-through; filter: grayscale(0.8); }

        /* ë¦¬ëª¨ì»¨ í¬ì»¤ìŠ¤ ìŠ¤íƒ€ì¼ */
        .task-item.active-focus, .control-btn.active-focus {
            border-color: var(--focus-border);
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.3); z-index: 10;
        }

        /* ìˆ¨ê²¨ì§„ í”Œë ˆì´ì–´ & ìŠ¤í¬ë¡¤ë°” */
        #player-container { position: fixed; bottom: 0; right: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .loading { grid-column: 1 / -1; text-align: center; font-size: 2rem; color: var(--text-secondary); margin-top: 5rem; }
    </style>
</head>

<body>

    <header class="top-bar">
        <div class="info-group">
            <div id="clock" class="clock">00:00</div>
            <div class="weather-widget">
                <div id="weather-main" class="weather-main"><span>--Â°C</span></div>
                <div class="weather-sub">ì°½ì›ì‹œ ë§ˆì‚°í•©í¬êµ¬</div>
            </div>
        </div>

        <div class="music-player-panel" id="music-panel">
            <div class="music-info">
                <div class="marquee-container">
                    <div class="music-title" id="music-title">Loading Music...</div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="music-progress"></div>
                </div>
            </div>
            <div class="music-controls">
                <div class="control-btn" id="btn-prev"><span class="material-symbols-rounded">skip_previous</span></div>
                <div class="control-btn main-action" id="btn-play"><span class="material-symbols-rounded">play_arrow</span></div>
                <div class="control-btn" id="btn-next"><span class="material-symbols-rounded">skip_next</span></div>
            </div>
        </div>
    </header>

    <main class="dashboard-body">
        <div class="section-title">
            <span>ì˜¤ëŠ˜ì˜ í•  ì¼</span>
            <span style="font-size: 1.2rem; font-weight: 400; align-self: flex-end;">OK: ì™„ë£Œ / ì±„ë„í‚¤: ìŒì•…ë„˜ê¹€</span>
        </div>

        <div class="task-progress-wrapper">
            <div id="task-progress-fill" class="task-progress-fill"></div>
            <div id="task-progress-text" class="task-progress-text">ë¡œë”© ì¤‘...</div>
        </div>

        <div id="tasks-grid" class="tasks-grid">
            <div class="loading">í•  ì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </main>

    <div id="player-container"><div id="player"></div></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const CONFIG = {
            // ì—¬ê¸°ì— ìƒˆë¡œ ë°°í¬í•œ GAS URLì„ ë„£ìœ¼ì„¸ìš”!
            GAS_URL: "https://script.google.com/macros/s/AKfycbzUyM0SeSq9FFK43e6ZcevhP3XMy4pqT6y64Azl2bA_YiRN4tDTKzHEYsBz8TwVgiA7Ww/exec", 
            PLAYLIST_ID: "PLJVvibrFbS3djZBF-cs-aW1oUFQFvXv0r",
            WEATHER_URL: "https://api.open-meteo.com/v1/forecast?latitude=35.2157&longitude=128.5676&current_weather=true&timezone=Asia%2FSeoul"
        };

        // 1. ì‹œê³„
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit' });
        }, 1000);

        // 2. ë‚ ì”¨
        async function updateWeather() {
            try {
                const res = await fetch(CONFIG.WEATHER_URL);
                const data = await res.json();
                if (data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    let icon = 'sunny';
                    if (code > 2) icon = 'cloud';
                    if (code > 45) icon = 'foggy';
                    if (code > 50) icon = 'rainy';
                    if (code > 70) icon = 'ac_unit';
                    if (code > 90) icon = 'thunderstorm';
                    let color = icon === 'sunny' ? '#FFD700' : (icon === 'rainy' ? '#4facfe' : '#ccc');
                    document.getElementById('weather-main').innerHTML = `<span class="material-symbols-rounded" style="font-size: 2.5rem; color: ${color};">${icon}</span> ${temp}Â°C`;
                }
            } catch (e) {}
        }
        updateWeather();

        // 3. í•  ì¼ ëª©ë¡ ë° ì§„í–‰ë¥  (ì™„ì „ ìˆ˜ì •ë¨)
        let tasksData = [];
        let currentFocusIndex = 0;

        async function fetchTasks() {
            const grid = document.getElementById('tasks-grid');
            const progressFill = document.getElementById('task-progress-fill');
            const progressText = document.getElementById('task-progress-text');

            try {
                const res = await fetch(CONFIG.GAS_URL);
                const data = await res.json();

                let taskList = [];
                let percent = 0;
                let doneCount = 0;
                let totalCount = 0;

                // ë°ì´í„° êµ¬ì¡° íŒë³„
                if (Array.isArray(data)) {
                    taskList = data;
                } else if (data.tasks) {
                    taskList = data.tasks;
                    percent = data.percent || 0;
                    doneCount = data.doneCount || 0;
                    totalCount = data.totalCount || 0;
                }

                // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸ (ì´ˆë¡ìƒ‰)
                if (progressFill && progressText) {
                    progressFill.style.width = percent + "%";
                    progressText.textContent = `ì˜¤ëŠ˜ì˜ ë‹¬ì„±ë¥ : ${percent}% (${doneCount}/${totalCount} ì™„ë£Œ)`;
                }

                // ëª©ë¡ ì—…ë°ì´íŠ¸
                if (!taskList || taskList.length === 0) {
                    grid.innerHTML = '<div class="loading">í•  ì¼ì„ ëª¨ë‘ ë§ˆì³¤ìŠµë‹ˆë‹¤! ğŸ‰</div>';
                    tasksData = [];
                    return;
                }

                tasksData = taskList;
                renderTasks();
            } catch (e) { console.error(e); }
        }

        function renderTasks() {
            const grid = document.getElementById('tasks-grid');
            grid.innerHTML = '';
            tasksData.forEach((task, index) => {
                const el = document.createElement('div');
                el.className = 'task-item';
                el.id = `task-${index}`;
                el.innerHTML = `<div class="task-bullet"></div><span>${task.title}</span>`;
                grid.appendChild(el);
            });
            updateFocus();
        }

        function completeTask(index) {
            const task = tasksData[index];
            const el = document.getElementById(`task-${index}`);
            if (!task || !el) return;
            el.classList.add('task-completed');
            
            fetch(CONFIG.GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'complete', taskId: task.id })
            }).then(() => {
                setTimeout(() => { fetchTasks(); }, 500);
            });
        }

        // 4. ë¦¬ëª¨ì»¨ ë‚´ë¹„ê²Œì´ì…˜ & ìŒì•… ì œì–´
        function updateFocus() {
            document.querySelectorAll('.active-focus').forEach(el => el.classList.remove('active-focus'));
            if (tasksData.length > 0) {
                if (currentFocusIndex >= tasksData.length) currentFocusIndex = tasksData.length - 1;
                if (currentFocusIndex < 0) currentFocusIndex = 0;
                const target = document.getElementById(`task-${currentFocusIndex}`);
                if (target) {
                    target.classList.add('active-focus');
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            const key = e.keyCode;
            
            // ë°©í–¥í‚¤ (3ì—´ ê·¸ë¦¬ë“œ ì´ë™)
            if (tasksData.length > 0) {
                if (key === 37) { if (currentFocusIndex > 0) currentFocusIndex--; updateFocus(); } // Left
                else if (key === 39) { if (currentFocusIndex < tasksData.length - 1) currentFocusIndex++; updateFocus(); } // Right
                else if (key === 38) { if (currentFocusIndex >= 3) currentFocusIndex -= 3; updateFocus(); } // Up
                else if (key === 40) { if (currentFocusIndex + 3 < tasksData.length) currentFocusIndex += 3; updateFocus(); } // Down
                else if (key === 13) { completeTask(currentFocusIndex); } // OK Button
            }

            // ì±„ë„í‚¤ (ìŒì•… ì œì–´)
            if (key === 427 || key === 33) { if (player) player.nextVideo(); } // CH Up / PageUp
            else if (key === 428 || key === 34) { if (player) player.previousVideo(); } // CH Down / PageDown
        });

        fetchTasks();
        setInterval(fetchTasks, 60000);

        // 5. ìŒì•… í”Œë ˆì´ì–´ (API)
        let player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                playerVars: {
                    listType: 'playlist', list: CONFIG.PLAYLIST_ID,
                    autoplay: 1, controls: 0, loop: 1, mute: 0
                },
                events: {
                    onReady: (e) => {
                        e.target.setShuffle(true);
                        e.target.playVideoAt(0);
                        setupMarquee();
                    },
                    onStateChange: onPlayerStateChange
                }
            });
        }

        function onPlayerStateChange(e) {
            if (player && player.getVideoData) {
                const data = player.getVideoData();
                const titleEl = document.getElementById('music-title');
                if (data && data.title) {
                    titleEl.textContent = data.title;
                    setupMarquee();
                }
            }
            const icon = document.querySelector('#btn-play span');
            if (e.data === YT.PlayerState.PLAYING) icon.textContent = 'pause';
            else icon.textContent = 'play_arrow';
        }

        function setupMarquee() {
            const container = document.querySelector('.marquee-container');
            const text = document.getElementById('music-title');
            text.style.animation = 'none';
            text.offsetHeight; 
            if (text.scrollWidth > container.clientWidth) {
                const duration = text.scrollWidth / 50; 
                text.style.animation = `scroll-left ${duration}s linear infinite`;
                text.style.paddingLeft = "100%";
            } else {
                text.style.paddingLeft = "0";
            }
        }

        // ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('btn-play').onclick = () => { if (player.getPlayerState() === 1) player.pauseVideo(); else player.playVideo(); };
        document.getElementById('btn-next').onclick = () => player.nextVideo();
        document.getElementById('btn-prev').onclick = () => player.previousVideo();

        // ìŒì•… ì§„í–‰ë°” ì—…ë°ì´íŠ¸
        setInterval(() => {
            if (player && player.getCurrentTime) {
                const pct = (player.getCurrentTime() / player.getDuration()) * 100;
                document.getElementById('music-progress').style.width = pct + "%";
            }
        }, 1000);
    </script>
</body>
</html>
