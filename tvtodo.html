<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Outfit:wght@300;500;700&display=swap"
        rel="stylesheet">
    <style>
        /* Global Styles */
        :root {
            --bg-color: #0f0f13;
            --text-color: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-color: #7c4dff;
            --secondary-text: rgba(255, 255, 255, 0.6);
            --font-heading: 'Outfit', sans-serif;
            --font-body: 'Noto Sans KR', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            color: var(--text-color);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        /* --- Top Bar --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }

        /* Info Area: Weather & Clock */
        .info-area {
            display: flex;
            align-items: center;
            gap: 2rem;
            font-family: var(--font-heading);
        }

        .weather-widget {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .clock {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #a0a0ff);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
        }

        /* Music Controls */
        .music-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            padding: 0.8rem 2rem;
            border-radius: 50px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .control-btn.active {
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        input[type=range] {
            width: 80px;
            accent-color: var(--accent-color);
        }


        /* --- Main Content: Task Grid --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            flex-grow: 1;
            overflow: hidden;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .tasks-header {
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 1rem;
        }

        .tasks-header h1 {
            font-family: var(--font-heading);
            font-size: 2rem;
            color: var(--secondary-text);
        }

        .tasks-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 2 Column Layout */
            grid-auto-rows: min-content;
            gap: 1.5rem;
            overflow-y: auto;
            padding-right: 0.5rem;
            height: 100%;
            align-content: start;
        }

        /* Scrollbar */
        .tasks-container::-webkit-scrollbar {
            width: 6px;
        }

        .tasks-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Individual Task Item */
        .task-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            font-size: 1.3rem;
            line-height: 1.6;
            animation: fadeIn 0.5s ease-out;
            cursor: pointer;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .task-bullet {
            min-width: 12px;
            height: 12px;
            background-color: var(--accent-color);
            border-radius: 50%;
            margin-top: 0.5rem;
            /* Align with text */
            margin-right: 1rem;
            box-shadow: 0 0 10px var(--accent-color);
        }

        .task-title {
            word-break: break-word;
            /* Wrap long text */
        }

        /* Completed Animation */
        .task-item.mod-completed {
            opacity: 0.5;
            text-decoration: line-through;
            transform: scale(0.95);
            pointer-events: none;
        }

        /* Mini Player (Visible to ensure playback, matching user's working example) */
        #player-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 200px;
            height: 120px;
            opacity: 0.8;
            /* Make it visible */
            z-index: 1000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s;
        }

        #player-container:hover {
            opacity: 1;
        }

        /* Utility */
        .loading-spinner {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--secondary-text);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s infinite linear;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <header class="top-bar">
        <!-- Info: Weather & Clock -->
        <div class="info-area">
            <div id="clock" class="clock">00:00</div>
            <div id="weather" class="weather-widget">
                <span>Loading...</span>
            </div>
        </div>

        <!-- Music Controls -->
        <div class="music-controls">
            <button class="control-btn" id="btn-shuffle" title="Shuffle">üîÄ</button>
            <button class="control-btn" id="btn-prev" title="Previous">‚èÆÔ∏è</button>
            <button class="control-btn" id="btn-play" title="Play/Pause">‚èØÔ∏è</button>
            <button class="control-btn" id="btn-next" title="Next">‚è≠Ô∏è</button>

            <div class="volume-container">
                <span style="font-size: 1.2rem;">üîä</span>
                <input type="range" id="vol-slider" min="0" max="100" value="100">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="glass-panel">
        <header class="tasks-header">
            <h1>Ïò§ÎäòÏùò Ìï† Ïùº</h1>
        </header>
        <div id="tasks-container" class="tasks-container">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <span>Î™©Î°ù Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
            </div>
        </div>
    </main>

    <!-- Hidden Player Container -->
    <div id="player-container">
        <div id="player"></div>
    </div>

    <!-- Scripts -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const CONFIG = {
            GAS_URL: "https://script.google.com/macros/s/AKfycbwDfpm8zj9UMWK1kgJBObyx27nYrwZ6foNQXemSpvFG2NAo55VncY0tJaYUX6IWjkOKDg/exec",
            YOUTUBE_PLAYLIST_ID: "PLJVvibrFbS3djZBF-cs-aW1oUFQFvXv0r",
            REFRESH_INTERVAL_MS: 5 * 60 * 1000 // 5 minutes
        };

        // --- 1. Clock ---
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- 2. Weather (Open-Meteo API) ---
        async function fetchWeather() {
            try {
                // Seoul Coordinates
                const url = "https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current_weather=true&timezone=Asia%2FSeoul";
                const res = await fetch(url);
                const data = await res.json();

                if (data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    let icon = "‚òÄÔ∏è";

                    // Simple WMO Code mapping
                    if (code >= 1 && code <= 3) icon = "‚õÖ";
                    else if (code >= 45 && code <= 48) icon = "üå´Ô∏è";
                    else if (code >= 51 && code <= 67) icon = "üåßÔ∏è";
                    else if (code >= 71 && code <= 77) icon = "‚ùÑÔ∏è";
                    else if (code >= 80 && code <= 99) icon = "‚õàÔ∏è";

                    document.getElementById('weather').innerHTML = `${icon} ${temp}¬∞C`;
                }
            } catch (e) {
                console.error("Weather fetch failed", e);
                document.getElementById('weather').textContent = "";
            }
        }
        fetchWeather();
        setInterval(fetchWeather, 30 * 60 * 1000); // 30 mins

        // --- 3. Google Tasks ---
        async function fetchTasks() {
            const container = document.getElementById('tasks-container');
            // Show loading only on first load
            if (!container.querySelector('.task-item') && !container.querySelector('.loading-spinner')) {
                // container.innerHTML = ...
            }

            try {
                const response = await fetch(CONFIG.GAS_URL);
                const data = await response.json();
                renderTasks(data);
            } catch (error) {
                console.error('Error fetching tasks:', error);
                if (container.querySelector('.loading-spinner')) {
                    container.innerHTML = `<div class="loading-spinner">
                        <p>‚ö†Ô∏è Î°úÎî© Ïã§Ìå®. <span onclick="fetchTasks()" style="text-decoration:underline;cursor:pointer;">Ïû¨ÏãúÎèÑ</span></p>
                    </div>`;
                }
            }
        }

        function renderTasks(data) {
            const container = document.getElementById('tasks-container');
            if (data.error) {
                console.error("GAS Error:", data.error);
                return;
            }
            if (!Array.isArray(data)) return;

            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<div class="loading-spinner"><p>Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§ ‚ú®</p></div>`;
                return;
            }

            data.forEach(task => {
                const el = document.createElement('div');
                el.className = 'task-item';
                el.onclick = () => completeTask(el, task.id);
                el.innerHTML = `<div class="task-bullet"></div><span class="task-title">${escapeHtml(task.title)}</span>`;
                container.appendChild(el);
            });
        }

        function completeTask(element, taskId) {
            element.classList.add('mod-completed');
            fetch(CONFIG.GAS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'complete', taskId: taskId })
            }).then(res => res.json()).then(data => {
                if (!data.success) {
                    element.classList.remove('mod-completed');
                    alert("ÏôÑÎ£å Ïã§Ìå®: " + data.error);
                } else {
                    setTimeout(() => element.style.display = 'none', 500);
                }
            }).catch(() => {
                element.classList.remove('mod-completed');
                alert("ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò");
            });
        }

        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#039;' }[m]));
        }

        fetchTasks();
        setInterval(fetchTasks, CONFIG.REFRESH_INTERVAL_MS);


        // --- 4. YouTube Player & Controls ---
        let player;
        let isShuffle = true;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'listType': 'playlist',
                    'list': CONFIG.YOUTUBE_PLAYLIST_ID,
                    'autoplay': 1,
                    'controls': 1, // Show controls as backup
                    'loop': 1,
                    'mute': 0,     // User confirmed mute=0 works
                    'rel': 0,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            // Shuffle and Play Muted first
            if (isShuffle) {
                event.target.setShuffle(true);
                event.target.playVideoAt(0);
            } else {
                event.target.playVideo();
            }
            setupControls();
        }

        function onPlayerStateChange(event) {
            const btn = document.getElementById('btn-play');

            // 1. Update Button Icon
            if (event.data == YT.PlayerState.PLAYING) {
                btn.textContent = "‚è∏Ô∏è";

                // 2. Attempt to Unmute on First Play
                // Browsers might block this if no user interaction yet.
                if (player.isMuted()) {
                    player.unMute();
                    // Double check volume
                    player.setVolume(50);
                }
            } else {
                btn.textContent = "‚èØÔ∏è";
            }
        }

        function onPlayerError(event) {
            console.error("YouTube Player Error:", event.data);
        }

        function setupControls() {
            document.getElementById('btn-prev').onclick = () => player.previousVideo();
            document.getElementById('btn-next').onclick = () => player.nextVideo();
            document.getElementById('btn-play').onclick = () => {
                const state = player.getPlayerState();
                if (state == YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                }
            };

            const shuffleBtn = document.getElementById('btn-shuffle');
            shuffleBtn.classList.add('active'); // Default ON
            shuffleBtn.onclick = () => {
                isShuffle = !isShuffle;
                player.setShuffle(isShuffle);
                // Visual feedback
                if (isShuffle) shuffleBtn.classList.add('active');
                else shuffleBtn.classList.remove('active');
            };

            const volSlider = document.getElementById('vol-slider');
            volSlider.oninput = (e) => {
                if (player) player.setVolume(e.target.value);
            };
        }

    </script>
</body>

</html>
